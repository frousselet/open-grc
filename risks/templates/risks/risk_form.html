{% extends "base.html" %}

{% block title %}{% if form.instance.pk %}Modifier{% else %}Nouveau{% endif %} risque â€” Open GRC{% endblock %}

{% block content %}
<h1>{% if form.instance.pk %}Modifier le risque{% else %}Nouveau risque{% endif %}</h1>

<form method="post" class="mt-3">
  {% csrf_token %}
  {% for field in form %}
  <div class="mb-3">
    {% if field.field.widget.input_type == 'checkbox' %}
    <div class="form-check">
      {{ field }}
      <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
    </div>
    {% else %}
    <label for="{{ field.id_for_label }}" class="form-label">
      {{ field.label }}{% if field.field.required %} *{% endif %}
    </label>
    {{ field }}
    {% endif %}
    {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
    {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
  </div>
  {% endfor %}
  <div class="mt-4">
    <button type="submit" class="btn btn-primary">Enregistrer</button>
    <a href="{% url 'risks:risk-list' %}" class="btn btn-secondary">Annuler</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var assessmentSelect = document.getElementById('id_assessment');
  if (!assessmentSelect) return;

  assessmentSelect.addEventListener('change', function() {
    var id = this.value;
    if (!id) return;
    fetch('{% url "risks:api-scale-choices" %}?assessment=' + id)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        updateSelect('id_initial_likelihood', data.likelihood);
        updateSelect('id_current_likelihood', data.likelihood);
        updateSelect('id_initial_impact', data.impact);
        updateSelect('id_current_impact', data.impact);
      });
  });

  function updateSelect(selectId, choices) {
    var sel = document.getElementById(selectId);
    if (!sel) return;
    var cur = sel.value;
    sel.innerHTML = '';
    choices.forEach(function(item) {
      var opt = document.createElement('option');
      opt.value = item.value;
      opt.textContent = item.label;
      if (item.value === cur) opt.selected = true;
      sel.appendChild(opt);
    });
  }
});
</script>
{% endblock %}
