{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ assessment.reference }} — Open GRC{% endblock %}

{% block extra_css %}
<style>
  .risk-matrix { table-layout: fixed; }
  .risk-matrix-corner { width: 90px; background: #f8f9fa; }
  .risk-matrix-header { font-size: .78rem; background: #f8f9fa; }
  .risk-matrix-row-label { font-size: .78rem; white-space: nowrap; background: #f8f9fa; text-align: right; padding-right: .6rem !important; }
  .risk-matrix-cell { position: relative; height: 60px; min-width: 60px; transition: transform .1s; cursor: default; }
  .risk-matrix-cell:hover { transform: scale(1.05); z-index: 1; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
  .risk-matrix-count { display: block; font-size: 1.3rem; font-weight: 700; line-height: 1.2; }
  .risk-matrix-level-name { display: block; font-size: .65rem; color: #495057; text-transform: uppercase; letter-spacing: .03em; }
  .risk-matrix-axis-label { border: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>{{ assessment.reference }} — {{ assessment.name }}</h1>
  <div>
    <a href="{% url 'risks:assessment-update' assessment.pk %}" class="btn btn-primary">{% trans "Edit" %}</a>
    <a href="{% url 'risks:assessment-list' %}" class="btn btn-outline-secondary">{% trans "Back" %}</a>
  </div>
</div>
{% include "includes/approval_badge.html" with object=assessment %}

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#general">{% trans "General" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#risks">{% trans "Risks" %}</a></li>
  {% if matrix_current or matrix_residual %}
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#matrices">{% trans "Matrices" %}</a></li>
  {% endif %}
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#iso27005">{% trans "ISO 27005 analyses" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#history">{% trans "History" %}</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="general">
    <dl class="row">
      <dt class="col-sm-3">{% trans "Scope" %}</dt><dd class="col-sm-9">{{ assessment.scope }}</dd>
      <dt class="col-sm-3">{% trans "Methodology" %}</dt><dd class="col-sm-9">{{ assessment.get_methodology_display }}</dd>
      <dt class="col-sm-3">{% trans "Assessor" %}</dt><dd class="col-sm-9">{{ assessment.assessor|default:"—" }}</dd>
      <dt class="col-sm-3">{% trans "Assessment date" %}</dt><dd class="col-sm-9">{{ assessment.assessment_date|default:"—" }}</dd>
      <dt class="col-sm-3">{% trans "Risk criteria" %}</dt><dd class="col-sm-9">{{ assessment.risk_criteria|default:"—" }}</dd>
      <dt class="col-sm-3">{% trans "Status" %}</dt>
      <dd class="col-sm-9">
        <span class="badge text-bg-{% if assessment.status == 'validated' %}success{% elif assessment.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
          {{ assessment.get_status_display }}
        </span>
      </dd>
      <dt class="col-sm-3">{% trans "Next review" %}</dt><dd class="col-sm-9">{{ assessment.next_review_date|default:"—" }}</dd>
      <dt class="col-sm-3">{% trans "Description" %}</dt><dd class="col-sm-9">{{ assessment.description|default:"—"|linebreaksbr }}</dd>
      <dt class="col-sm-3">{% trans "Summary" %}</dt><dd class="col-sm-9">{{ assessment.summary|default:"—"|linebreaksbr }}</dd>
    </dl>
  </div>

  <div class="tab-pane fade" id="risks">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>{% trans "Associated risks" %}</h5>
      <a href="{% url 'risks:risk-create' %}?assessment={{ assessment.pk }}" class="btn btn-sm btn-primary">{% trans "Add a risk" %}</a>
    </div>
    {% if risks %}
    <table class="table table-striped">
      <thead><tr><th>{% trans "Ref." %}</th><th>{% trans "Name" %}</th><th>{% trans "Priority" %}</th><th>{% trans "Status" %}</th><th>{% trans "Current level" %}</th></tr></thead>
      <tbody>
        {% for r in risks %}
        <tr>
          <td>{{ r.reference }}</td>
          <td><a href="{% url 'risks:risk-detail' r.pk %}">{{ r.name }}</a></td>
          <td><span class="badge text-bg-{% if r.priority == 'critical' %}danger{% elif r.priority == 'high' %}warning{% elif r.priority == 'medium' %}info{% else %}secondary{% endif %}">{{ r.get_priority_display }}</span></td>
          <td>{{ r.get_status_display }}</td>
          <td>{{ r.current_risk_level|default:"—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">{% trans "No associated risk." %}</p>
    {% endif %}
  </div>

  {% if matrix_current or matrix_residual %}
  <div class="tab-pane fade" id="matrices">
    <h5 class="mb-3">{% trans "Risk matrices" %}
      {% if matrix_criteria %}<small class="text-muted fw-normal ms-2">({{ matrix_criteria.name }})</small>{% endif %}
    </h5>
    <div class="row g-3">
      {% if matrix_current %}
      <div class="col-lg-6">
        {% trans "Current risks (before treatment)" as matrix_title %}
        {% include "risks/includes/risk_matrix.html" with matrix=matrix_current title=matrix_title %}
      </div>
      {% endif %}
      {% if matrix_residual %}
      <div class="col-lg-6">
        {% trans "Residual risks (after treatment)" as matrix_title %}
        {% include "risks/includes/risk_matrix.html" with matrix=matrix_residual title=matrix_title %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="tab-pane fade" id="iso27005">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>{% trans "ISO 27005 analyses" %}</h5>
      <a href="{% url 'risks:iso27005-create' %}?assessment={{ assessment.pk }}" class="btn btn-sm btn-primary">{% trans "New analysis" %}</a>
    </div>
    {% if iso27005_risks %}
    <table class="table table-striped">
      <thead><tr><th>{% trans "Threat" %}</th><th>{% trans "Vulnerability" %}</th><th>{% trans "Likelihood" %}</th><th>{% trans "Max impact" %}</th><th>{% trans "Level" %}</th></tr></thead>
      <tbody>
        {% for a in iso27005_risks %}
        <tr>
          <td><a href="{% url 'risks:iso27005-detail' a.pk %}">{{ a.threat.name }}</a></td>
          <td>{{ a.vulnerability.name }}</td>
          <td>{{ a.combined_likelihood|default:"—" }}</td>
          <td>{{ a.max_impact|default:"—" }}</td>
          <td>{{ a.risk_level|default:"—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">{% trans "No ISO 27005 analysis." %}</p>
    {% endif %}
  </div>

  <div class="tab-pane fade" id="history">
    {% include "includes/history_tab.html" %}
  </div>
</div>
{% endblock %}
