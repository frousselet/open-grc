{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ assessment.reference }} — Open GRC{% endblock %}

{% block extra_css %}
<style>
  .risk-matrix { table-layout: fixed; }
  .risk-matrix-corner { width: 90px; background: #f8f9fa; }
  .risk-matrix-header { font-size: .78rem; background: #f8f9fa; }
  .risk-matrix-row-label { font-size: .78rem; white-space: nowrap; background: #f8f9fa; text-align: right; padding-right: .6rem !important; }
  .risk-matrix-cell { position: relative; height: 60px; min-width: 60px; transition: transform .1s; cursor: default; }
  .risk-matrix-cell:hover { transform: scale(1.05); z-index: 1; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
  .risk-matrix-count { display: block; font-size: 1.3rem; font-weight: 700; line-height: 1.2; }
  .risk-matrix-level-name { display: block; font-size: .65rem; color: #495057; text-transform: uppercase; letter-spacing: .03em; }
  .risk-matrix-axis-label { border: none !important; }
  .workflow-step { display: flex; align-items: center; gap: .75rem; padding: .75rem 1rem; border-radius: .5rem; margin-bottom: .5rem; }
  .workflow-step:last-child { margin-bottom: 0; }
  .workflow-step .step-number { width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: .85rem; flex-shrink: 0; }
  .workflow-step-done .step-number { background: #198754; color: #fff; }
  .workflow-step-active .step-number { background: #0d6efd; color: #fff; }
  .workflow-step-pending .step-number { background: #e9ecef; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>{{ assessment.reference }} — {{ assessment.name }}</h1>
  <div class="d-flex gap-2">
    <a href="{% url 'risks:assessment-update' assessment.pk %}" class="btn btn-primary">{% trans "Edit" %}</a>
    <a href="{% url 'risks:assessment-list' %}" class="btn btn-outline-secondary">{% trans "Back" %}</a>
  </div>
</div>
{% include "includes/approval_badge.html" with object=assessment %}

<div class="mb-4">
  <span class="badge text-bg-{% if assessment.methodology == 'iso27005' %}primary{% elif assessment.methodology == 'ebios_rm' %}info{% else %}secondary{% endif %} fs-6">
    <i class="bi bi-diagram-2 me-1"></i>{{ assessment.get_methodology_display }}
  </span>
  <span class="badge text-bg-{% if assessment.status == 'validated' %}success{% elif assessment.status == 'in_progress' %}warning{% else %}secondary{% endif %} fs-6 ms-1">
    {{ assessment.get_status_display }}
  </span>
</div>

{# ══════════════════════════════════════════════════════════ #}
{# ── Methodology workflow — always visible ─────────────── #}
{# ══════════════════════════════════════════════════════════ #}

{% if assessment.methodology == 'iso27005' %}
<div class="card mb-4" style="border-left:4px solid var(--accent)">
  <div class="card-header d-flex align-items-center">
    <h5 class="mb-0"><i class="bi bi-signpost-2 me-2"></i>{% trans "ISO 27005 workflow" %}</h5>
  </div>
  <div class="card-body">
    <div class="workflow-step {% if threat_count > 0 %}workflow-step-done{% else %}workflow-step-active{% endif %}">
      <span class="step-number">1</span>
      <div>
        <strong>{% trans "Identify threats" %}</strong>
        <div class="text-muted small">{% trans "Define or select threats from the catalog that apply to your scope." %}</div>
      </div>
      <span class="ms-auto badge text-bg-{% if threat_count > 0 %}success{% else %}secondary{% endif %}">{{ threat_count }} {% trans "threat(s)" %}</span>
      <a href="{% url 'risks:threat-list' %}" class="btn btn-sm btn-outline-primary ms-2">{% trans "Manage" %}</a>
    </div>
    <div class="workflow-step {% if vulnerability_count > 0 %}workflow-step-done{% elif threat_count > 0 %}workflow-step-active{% else %}workflow-step-pending{% endif %}">
      <span class="step-number">2</span>
      <div>
        <strong>{% trans "Identify vulnerabilities" %}</strong>
        <div class="text-muted small">{% trans "Define or select vulnerabilities from the catalog." %}</div>
      </div>
      <span class="ms-auto badge text-bg-{% if vulnerability_count > 0 %}success{% else %}secondary{% endif %}">{{ vulnerability_count }} {% trans "vulnerability(ies)" %}</span>
      <a href="{% url 'risks:vulnerability-list' %}" class="btn btn-sm btn-outline-primary ms-2">{% trans "Manage" %}</a>
    </div>
    <div class="workflow-step {% if iso27005_risks %}workflow-step-done{% elif vulnerability_count > 0 %}workflow-step-active{% else %}workflow-step-pending{% endif %}">
      <span class="step-number">3</span>
      <div>
        <strong>{% trans "Analyze risk scenarios" %}</strong>
        <div class="text-muted small">{% trans "Create threat × vulnerability scenarios and evaluate their likelihood and impact." %}</div>
      </div>
      <span class="ms-auto badge text-bg-{% if iso27005_risks %}success{% else %}secondary{% endif %}">{{ iso27005_risks|length }} {% trans "analysis(es)" %}</span>
      <a href="{% url 'risks:iso27005-create' %}?assessment={{ assessment.pk }}" class="btn btn-sm btn-primary ms-2">{% trans "New analysis" %}</a>
    </div>
    <div class="workflow-step {% if risks %}workflow-step-done{% elif iso27005_risks %}workflow-step-active{% else %}workflow-step-pending{% endif %}">
      <span class="step-number">4</span>
      <div>
        <strong>{% trans "Consolidate risks" %}</strong>
        <div class="text-muted small">{% trans "Promote analyses to the risk register for treatment planning." %}</div>
      </div>
      <span class="ms-auto badge text-bg-{% if risks %}success{% else %}secondary{% endif %}">{{ risks|length }} {% trans "risk(s)" %}</span>
    </div>
  </div>
</div>

{% elif assessment.methodology == 'ebios_rm' %}
<div class="card mb-4" style="border-left:4px solid var(--info)">
  <div class="card-header d-flex align-items-center">
    <h5 class="mb-0"><i class="bi bi-signpost-2 me-2"></i>{% trans "EBIOS RM workflow" %}</h5>
  </div>
  <div class="card-body">
    <div class="alert alert-warning mb-3">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {% trans "The EBIOS RM methodology is not yet implemented. It will be available in a future version." %}
    </div>
    <div class="workflow-step workflow-step-pending">
      <span class="step-number">1</span>
      <div>
        <strong>{% trans "Define scope and security baseline" %}</strong>
        <div class="text-muted small">{% trans "Workshop 1 — Identify essential assets, business values and the security baseline." %}</div>
      </div>
    </div>
    <div class="workflow-step workflow-step-pending">
      <span class="step-number">2</span>
      <div>
        <strong>{% trans "Identify risk origins" %}</strong>
        <div class="text-muted small">{% trans "Workshop 2 — Identify threat sources and their objectives." %}</div>
      </div>
    </div>
    <div class="workflow-step workflow-step-pending">
      <span class="step-number">3</span>
      <div>
        <strong>{% trans "Build strategic scenarios" %}</strong>
        <div class="text-muted small">{% trans "Workshop 3 — Define attack paths from threat source to essential assets." %}</div>
      </div>
    </div>
    <div class="workflow-step workflow-step-pending">
      <span class="step-number">4</span>
      <div>
        <strong>{% trans "Build operational scenarios" %}</strong>
        <div class="text-muted small">{% trans "Workshop 4 — Detail technical attack sequences on support assets." %}</div>
      </div>
    </div>
    <div class="workflow-step workflow-step-pending">
      <span class="step-number">5</span>
      <div>
        <strong>{% trans "Treat risks" %}</strong>
        <div class="text-muted small">{% trans "Workshop 5 — Define and track risk treatment measures." %}</div>
      </div>
    </div>
  </div>
</div>

{% else %}
<div class="alert alert-warning mb-4">
  <i class="bi bi-exclamation-triangle me-2"></i>
  {% trans "Unknown methodology. Please edit this assessment and select a valid methodology." %}
</div>
{% endif %}

{# ══════════════════════════════════════════════════════════ #}
{# ── Tabs ──────────────────────────────────────────────── #}
{# ══════════════════════════════════════════════════════════ #}

<ul class="nav nav-tabs mb-3" role="tablist">
  {% if assessment.methodology == 'iso27005' %}
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#analyses">{% trans "Analyses" %}</a></li>
  {% endif %}
  <li class="nav-item"><a class="nav-link {% if assessment.methodology != 'iso27005' %}active{% endif %}" data-bs-toggle="tab" href="#risks">{% trans "Risks" %}</a></li>
  {% if matrix_current or matrix_residual %}
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#matrices">{% trans "Matrices" %}</a></li>
  {% endif %}
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#general">{% trans "General" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#history">{% trans "History" %}</a></li>
</ul>

<div class="tab-content">
  {# ── ISO 27005 Analyses tab ──────────────────────────── #}
  {% if assessment.methodology == 'iso27005' %}
  <div class="tab-pane fade show active" id="analyses">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">{% trans "ISO 27005 analyses" %}</h5>
      <a href="{% url 'risks:iso27005-create' %}?assessment={{ assessment.pk }}" class="btn btn-sm btn-primary">{% trans "New analysis" %}</a>
    </div>
    {% if iso27005_risks %}
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead><tr>
            <th>{% trans "Threat" %}</th>
            <th>{% trans "Vulnerability" %}</th>
            <th>{% trans "Likelihood" %}</th>
            <th>{% trans "Max impact" %}</th>
            <th>{% trans "Level" %}</th>
            <th>{% trans "Consolidated risk" %}</th>
            <th>{% trans "Actions" %}</th>
          </tr></thead>
          <tbody>
            {% for a in iso27005_risks %}
            <tr>
              <td><a href="{% url 'risks:iso27005-detail' a.pk %}" style="color:var(--accent);text-decoration:none;font-weight:500">{{ a.threat.name }}</a></td>
              <td>{{ a.vulnerability.name }}</td>
              <td>{{ a.combined_likelihood|default:"—" }}</td>
              <td>{{ a.max_impact|default:"—" }}</td>
              <td>{{ a.risk_level|default:"—" }}</td>
              <td>
                {% if a.risk %}
                <a href="{% url 'risks:risk-detail' a.risk.pk %}" style="color:var(--accent);text-decoration:none;font-weight:500">{{ a.risk.reference }}</a>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'risks:iso27005-update' a.pk %}" class="btn btn-sm btn-outline-primary">{% trans "Edit" %}</a>
                {% if not a.risk and a.risk_level %}
                <form method="post" action="{% url 'risks:iso27005-consolidate' a.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-success" title="{% trans 'Consolidate as risk' %}">
                    <i class="bi bi-arrow-up-circle"></i> {% trans "Consolidate" %}
                  </button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      {% trans "No analyses yet. Start by creating threat × vulnerability scenarios to identify risks." %}
    </div>
    {% endif %}
  </div>
  {% endif %}

  {# ── Risks tab ─────────────────────────────────────── #}
  <div class="tab-pane fade {% if assessment.methodology != 'iso27005' %}show active{% endif %}" id="risks">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">{% trans "Associated risks" %}</h5>
      {% if assessment.methodology == 'iso27005' %}
      <span class="text-muted small">
        <i class="bi bi-info-circle me-1"></i>{% trans "Risks are created by consolidating ISO 27005 analyses." %}
      </span>
      {% endif %}
    </div>
    {% if risks %}
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead><tr>
            <th>{% trans "Ref." %}</th>
            <th>{% trans "Name" %}</th>
            <th>{% trans "Priority" %}</th>
            <th>{% trans "Status" %}</th>
            <th>{% trans "Current level" %}</th>
            <th>{% trans "Treatment" %}</th>
            <th>{% trans "Actions" %}</th>
          </tr></thead>
          <tbody>
            {% for r in risks %}
            <tr>
              <td>{{ r.reference }}</td>
              <td><a href="{% url 'risks:risk-detail' r.pk %}" style="color:var(--accent);text-decoration:none;font-weight:500">{{ r.name }}</a></td>
              <td><span class="badge text-bg-{% if r.priority == 'critical' %}danger{% elif r.priority == 'high' %}warning{% elif r.priority == 'medium' %}info{% else %}secondary{% endif %}">{{ r.get_priority_display }}</span></td>
              <td>{{ r.get_status_display }}</td>
              <td>{{ r.current_risk_level|default:"—" }}</td>
              <td>{{ r.get_treatment_decision_display }}</td>
              <td><a href="{% url 'risks:risk-update' r.pk %}" class="btn btn-sm btn-outline-primary">{% trans "Edit" %}</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <p style="color:var(--text-muted);font-size:.85rem">{% trans "No associated risk." %}</p>
    {% endif %}
  </div>

  {# ── Matrices tab ──────────────────────────────────── #}
  {% if matrix_current or matrix_residual %}
  <div class="tab-pane fade" id="matrices">
    <h5 class="mb-3">{% trans "Risk matrices" %}
      {% if matrix_criteria %}<small class="text-muted fw-normal ms-2">({{ matrix_criteria.name }})</small>{% endif %}
    </h5>
    <div class="row g-3">
      {% if matrix_current %}
      <div class="col-lg-6">
        {% trans "Current risks (before treatment)" as matrix_title %}
        {% include "risks/includes/risk_matrix.html" with matrix=matrix_current title=matrix_title %}
      </div>
      {% endif %}
      {% if matrix_residual %}
      <div class="col-lg-6">
        {% trans "Residual risks (after treatment)" as matrix_title %}
        {% include "risks/includes/risk_matrix.html" with matrix=matrix_residual title=matrix_title %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {# ── General tab ────────────────────────────────────── #}
  <div class="tab-pane fade" id="general">
    <div class="card">
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Scope" %}</dt><dd class="col-sm-9">{{ assessment.scope }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Methodology" %}</dt><dd class="col-sm-9">{{ assessment.get_methodology_display }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Assessor" %}</dt><dd class="col-sm-9">{{ assessment.assessor|default:"—" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Assessment date" %}</dt><dd class="col-sm-9">{{ assessment.assessment_date|default:"—" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Risk criteria" %}</dt><dd class="col-sm-9">{{ assessment.risk_criteria|default:"—" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Status" %}</dt>
          <dd class="col-sm-9">
            <span class="badge text-bg-{% if assessment.status == 'validated' %}success{% elif assessment.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
              {{ assessment.get_status_display }}
            </span>
          </dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Next review" %}</dt><dd class="col-sm-9">{{ assessment.next_review_date|default:"—" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Description" %}</dt><dd class="col-sm-9">{{ assessment.description|default:"—"|linebreaksbr }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Summary" %}</dt><dd class="col-sm-9">{{ assessment.summary|default:"—"|linebreaksbr }}</dd>
        </dl>
      </div>
    </div>
  </div>

  {# ── History tab ───────────────────────────────────── #}
  <div class="tab-pane fade" id="history">
    {% include "includes/history_tab.html" %}
  </div>
</div>
{% endblock %}
