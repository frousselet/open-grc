{% extends "base.html" %}

{% block title %}{{ assessment.reference }} — Open GRC{% endblock %}

{% block extra_css %}
<style>
  .risk-matrix { table-layout: fixed; }
  .risk-matrix-corner { width: 90px; background: #f8f9fa; }
  .risk-matrix-header { font-size: .78rem; background: #f8f9fa; }
  .risk-matrix-row-label { font-size: .78rem; white-space: nowrap; background: #f8f9fa; text-align: right; padding-right: .6rem !important; }
  .risk-matrix-cell { position: relative; height: 60px; min-width: 60px; transition: transform .1s; cursor: default; }
  .risk-matrix-cell:hover { transform: scale(1.05); z-index: 1; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
  .risk-matrix-count { display: block; font-size: 1.3rem; font-weight: 700; line-height: 1.2; }
  .risk-matrix-level-name { display: block; font-size: .65rem; color: #495057; text-transform: uppercase; letter-spacing: .03em; }
  .risk-matrix-axis-label { border: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>{{ assessment.reference }} — {{ assessment.name }}</h1>
  <div>
    <a href="{% url 'risks:assessment-update' assessment.pk %}" class="btn btn-primary">Modifier</a>
    <a href="{% url 'risks:assessment-list' %}" class="btn btn-outline-secondary">Retour</a>
  </div>
</div>
{% include "includes/approval_badge.html" with object=assessment %}

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#general">Général</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#risks">Risques</a></li>
  {% if matrix_current or matrix_residual %}
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#matrices">Matrices</a></li>
  {% endif %}
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#iso27005">Analyses ISO 27005</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#history">Historique</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="general">
    <dl class="row">
      <dt class="col-sm-3">Périmètre</dt><dd class="col-sm-9">{{ assessment.scope }}</dd>
      <dt class="col-sm-3">Méthodologie</dt><dd class="col-sm-9">{{ assessment.get_methodology_display }}</dd>
      <dt class="col-sm-3">Appréciateur</dt><dd class="col-sm-9">{{ assessment.assessor|default:"—" }}</dd>
      <dt class="col-sm-3">Date d'appréciation</dt><dd class="col-sm-9">{{ assessment.assessment_date|default:"—" }}</dd>
      <dt class="col-sm-3">Critères de risque</dt><dd class="col-sm-9">{{ assessment.risk_criteria|default:"—" }}</dd>
      <dt class="col-sm-3">Statut</dt>
      <dd class="col-sm-9">
        <span class="badge text-bg-{% if assessment.status == 'validated' %}success{% elif assessment.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
          {{ assessment.get_status_display }}
        </span>
      </dd>
      <dt class="col-sm-3">Prochaine revue</dt><dd class="col-sm-9">{{ assessment.next_review_date|default:"—" }}</dd>
      <dt class="col-sm-3">Description</dt><dd class="col-sm-9">{{ assessment.description|default:"—"|linebreaksbr }}</dd>
      <dt class="col-sm-3">Synthèse</dt><dd class="col-sm-9">{{ assessment.summary|default:"—"|linebreaksbr }}</dd>
    </dl>
  </div>

  <div class="tab-pane fade" id="risks">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Risques associés</h5>
      <a href="{% url 'risks:risk-create' %}?assessment={{ assessment.pk }}" class="btn btn-sm btn-primary">Ajouter un risque</a>
    </div>
    {% if risks %}
    <table class="table table-striped">
      <thead><tr><th>Réf.</th><th>Nom</th><th>Priorité</th><th>Statut</th><th>Niveau actuel</th></tr></thead>
      <tbody>
        {% for r in risks %}
        <tr>
          <td>{{ r.reference }}</td>
          <td><a href="{% url 'risks:risk-detail' r.pk %}">{{ r.name }}</a></td>
          <td><span class="badge text-bg-{% if r.priority == 'critical' %}danger{% elif r.priority == 'high' %}warning{% elif r.priority == 'medium' %}info{% else %}secondary{% endif %}">{{ r.get_priority_display }}</span></td>
          <td>{{ r.get_status_display }}</td>
          <td>{{ r.current_risk_level|default:"—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">Aucun risque associé.</p>
    {% endif %}
  </div>

  {% if matrix_current or matrix_residual %}
  <div class="tab-pane fade" id="matrices">
    <h5 class="mb-3">Matrices de risques
      {% if matrix_criteria %}<small class="text-muted fw-normal ms-2">({{ matrix_criteria.name }})</small>{% endif %}
    </h5>
    <div class="row g-3">
      {% if matrix_current %}
      <div class="col-lg-6">
        {% include "risks/includes/risk_matrix.html" with matrix=matrix_current title="Risques réels (avant traitement)" %}
      </div>
      {% endif %}
      {% if matrix_residual %}
      <div class="col-lg-6">
        {% include "risks/includes/risk_matrix.html" with matrix=matrix_residual title="Risques résiduels (après traitement)" %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="tab-pane fade" id="iso27005">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Analyses ISO 27005</h5>
      <a href="{% url 'risks:iso27005-create' %}?assessment={{ assessment.pk }}" class="btn btn-sm btn-primary">Nouvelle analyse</a>
    </div>
    {% if iso27005_risks %}
    <table class="table table-striped">
      <thead><tr><th>Menace</th><th>Vulnérabilité</th><th>Vraisemblance</th><th>Impact max</th><th>Niveau</th></tr></thead>
      <tbody>
        {% for a in iso27005_risks %}
        <tr>
          <td><a href="{% url 'risks:iso27005-detail' a.pk %}">{{ a.threat.name }}</a></td>
          <td>{{ a.vulnerability.name }}</td>
          <td>{{ a.combined_likelihood|default:"—" }}</td>
          <td>{{ a.max_impact|default:"—" }}</td>
          <td>{{ a.risk_level|default:"—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">Aucune analyse ISO 27005.</p>
    {% endif %}
  </div>

  <div class="tab-pane fade" id="history">
    {% include "includes/history_tab.html" %}
  </div>
</div>
{% endblock %}
