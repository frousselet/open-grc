{% extends "base.html" %}

{% block title %}{% if form.instance.pk %}Modifier{% else %}Nouveaux{% endif %} critères — Open GRC{% endblock %}

{% block extra_css %}
<style>
  .formset-table th { font-size: .85rem; }
  .formset-table td { vertical-align: middle; }
  .formset-table .form-control,
  .formset-table .form-select { font-size: .85rem; padding: .3rem .5rem; }
  .formset-table .form-check-input { margin-top: .35rem; }
</style>
{% endblock %}

{% block content %}
<h1>{% if form.instance.pk %}Modifier les critères de risque{% else %}Nouveaux critères de risque{% endif %}</h1>

<form method="post" class="mt-3">
  {% csrf_token %}

  {# ── Informations générales ──────────────────────────── #}
  <div class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Informations générales</h5></div>
    <div class="card-body">
      {% for field in form %}
      <div class="mb-3">
        {% if field.field.widget.input_type == 'checkbox' %}
        <div class="form-check">
          {{ field }}
          <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
        </div>
        {% else %}
        <label for="{{ field.id_for_label }}" class="form-label">
          {{ field.label }}{% if field.field.required %} *{% endif %}
        </label>
        {{ field }}
        {% endif %}
        {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
        {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
      </div>
      {% endfor %}
    </div>
  </div>

  {# ── Échelle de vraisemblance ────────────────────────── #}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-arrow-up-right me-1"></i> Échelle de vraisemblance</h5>
    </div>
    <div class="card-body">
      {{ likelihood_fs.management_form }}
      <table class="table table-sm formset-table mb-0" id="likelihood-table">
        <thead>
          <tr>
            <th style="width:80px">Niveau</th>
            <th>Libellé</th>
            <th>Description</th>
            <th style="width:60px" class="text-center">Suppr.</th>
          </tr>
        </thead>
        <tbody>
          {% for fs_form in likelihood_fs %}
          <tr>
            {{ fs_form.id }}
            <td>{{ fs_form.level }}</td>
            <td>{{ fs_form.name }}</td>
            <td>{{ fs_form.description }}</td>
            <td class="text-center">{{ fs_form.DELETE }}</td>
          </tr>
          {% if fs_form.errors %}
          <tr><td colspan="4"><div class="text-danger small">{{ fs_form.errors }}</div></td></tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addFormsetRow('likelihood', 4)">
        <i class="bi bi-plus-circle me-1"></i>Ajouter un niveau
      </button>
    </div>
  </div>

  {# ── Échelle d'impact ────────────────────────────────── #}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-bullseye me-1"></i> Échelle d'impact</h5>
    </div>
    <div class="card-body">
      {{ impact_fs.management_form }}
      <table class="table table-sm formset-table mb-0" id="impact-table">
        <thead>
          <tr>
            <th style="width:80px">Niveau</th>
            <th>Libellé</th>
            <th>Description</th>
            <th style="width:60px" class="text-center">Suppr.</th>
          </tr>
        </thead>
        <tbody>
          {% for fs_form in impact_fs %}
          <tr>
            {{ fs_form.id }}
            <td>{{ fs_form.level }}</td>
            <td>{{ fs_form.name }}</td>
            <td>{{ fs_form.description }}</td>
            <td class="text-center">{{ fs_form.DELETE }}</td>
          </tr>
          {% if fs_form.errors %}
          <tr><td colspan="4"><div class="text-danger small">{{ fs_form.errors }}</div></td></tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addFormsetRow('impact', 4)">
        <i class="bi bi-plus-circle me-1"></i>Ajouter un niveau
      </button>
    </div>
  </div>

  {# ── Niveaux de risque ───────────────────────────────── #}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-thermometer-half me-1"></i> Niveaux de risque</h5>
    </div>
    <div class="card-body">
      {{ risklevel_fs.management_form }}
      <table class="table table-sm formset-table mb-0" id="risklevel-table">
        <thead>
          <tr>
            <th style="width:80px">Niveau</th>
            <th>Libellé</th>
            <th style="width:80px">Couleur</th>
            <th style="width:140px" class="text-center">Traitement requis</th>
            <th style="width:60px" class="text-center">Suppr.</th>
          </tr>
        </thead>
        <tbody>
          {% for fs_form in risklevel_fs %}
          <tr>
            {{ fs_form.id }}
            <td>{{ fs_form.level }}</td>
            <td>{{ fs_form.name }}</td>
            <td>{{ fs_form.color }}</td>
            <td class="text-center">{{ fs_form.requires_treatment }}</td>
            <td class="text-center">{{ fs_form.DELETE }}</td>
          </tr>
          {% if fs_form.errors %}
          <tr><td colspan="5"><div class="text-danger small">{{ fs_form.errors }}</div></td></tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addFormsetRow('risklevel', 5)">
        <i class="bi bi-plus-circle me-1"></i>Ajouter un niveau
      </button>
    </div>
  </div>

  <div class="mt-4">
    <button type="submit" class="btn btn-primary">Enregistrer</button>
    <a href="{% url 'risks:criteria-list' %}" class="btn btn-secondary">Annuler</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function addFormsetRow(prefix, numCols) {
  var totalInput = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
  var idx = parseInt(totalInput.value, 10);
  var tbody = document.querySelector('#' + prefix + '-table tbody');

  // Compute next level number from existing rows
  var nextLevel = idx + 1;
  var rows = tbody.querySelectorAll('tr');
  for (var i = rows.length - 1; i >= 0; i--) {
    var inp = rows[i].querySelector('input[name$="-level"]');
    if (inp && inp.value) {
      nextLevel = parseInt(inp.value, 10) + 1;
      break;
    }
  }

  var tr = document.createElement('tr');

  if (prefix === 'risklevel') {
    tr.innerHTML =
      '<td><input type="number" name="' + prefix + '-' + idx + '-level" id="id_' + prefix + '-' + idx + '-level" value="' + nextLevel + '" class="form-control" style="width:80px"></td>' +
      '<td><input type="text" name="' + prefix + '-' + idx + '-name" id="id_' + prefix + '-' + idx + '-name" class="form-control" maxlength="100"></td>' +
      '<td><input type="color" name="' + prefix + '-' + idx + '-color" id="id_' + prefix + '-' + idx + '-color" value="#6c757d" class="form-control" style="width:60px; padding:2px"></td>' +
      '<td class="text-center"><input type="checkbox" name="' + prefix + '-' + idx + '-requires_treatment" id="id_' + prefix + '-' + idx + '-requires_treatment" class="form-check-input"></td>' +
      '<td class="text-center"><input type="checkbox" name="' + prefix + '-' + idx + '-DELETE" id="id_' + prefix + '-' + idx + '-DELETE" class="form-check-input"></td>';
  } else {
    tr.innerHTML =
      '<td><input type="number" name="' + prefix + '-' + idx + '-level" id="id_' + prefix + '-' + idx + '-level" value="' + nextLevel + '" class="form-control" style="width:80px"></td>' +
      '<td><input type="text" name="' + prefix + '-' + idx + '-name" id="id_' + prefix + '-' + idx + '-name" class="form-control" maxlength="100"></td>' +
      '<td><input type="text" name="' + prefix + '-' + idx + '-description" id="id_' + prefix + '-' + idx + '-description" class="form-control"></td>' +
      '<td class="text-center"><input type="checkbox" name="' + prefix + '-' + idx + '-DELETE" id="id_' + prefix + '-' + idx + '-DELETE" class="form-check-input"></td>';
  }

  tbody.appendChild(tr);
  totalInput.value = idx + 1;
}
</script>
{% endblock %}
