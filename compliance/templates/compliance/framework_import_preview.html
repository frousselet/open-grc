{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Import preview" %} — Open GRC{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-3">
  <h1 class="mb-0">{% trans "Import preview" %}</h1>
</div>

{% if existing_framework %}
<div class="alert alert-info">
  <i class="bi bi-info-circle me-1"></i>
  {% blocktrans with ref=existing_framework.reference name=existing_framework.name new_name=framework.name %}Import into existing framework <strong>{{ ref }} — {{ name }}</strong>. The name will be replaced by <strong>{{ new_name }}</strong>.{% endblocktrans %}
</div>
{% endif %}

{# ── Metadata card ────────────────────────────────────── #}
<div class="card mb-3">
  <div class="card-header" style="font-weight:600;font-size:.85rem;background:var(--surface-muted);border-bottom:1px solid var(--border-light)">{% if existing_framework %}{% trans "Imported data" %}{% else %}{% trans "Framework metadata" %}{% endif %}</div>
  <div class="card-body">
    <dl class="row mb-0">
      <dt class="col-sm-3">{% trans "Reference" %}</dt>
      <dd class="col-sm-9">{{ framework.reference }}</dd>
      <dt class="col-sm-3">{% trans "Name" %}</dt>
      <dd class="col-sm-9">{{ framework.name }}</dd>
      {% if framework.short_name %}
      <dt class="col-sm-3">{% trans "Abbreviation" %}</dt>
      <dd class="col-sm-9">{{ framework.short_name }}</dd>
      {% endif %}
      {% if framework.type %}
      <dt class="col-sm-3">{% trans "Type" %}</dt>
      <dd class="col-sm-9">{{ framework.type }}</dd>
      {% endif %}
      {% if framework.category %}
      <dt class="col-sm-3">{% trans "Category" %}</dt>
      <dd class="col-sm-9">{{ framework.category }}</dd>
      {% endif %}
      {% if framework.issuing_body %}
      <dt class="col-sm-3">{% trans "Issuing body" %}</dt>
      <dd class="col-sm-9">{{ framework.issuing_body }}</dd>
      {% endif %}
      {% if framework.description %}
      <dt class="col-sm-3">{% trans "Description" %}</dt>
      <dd class="col-sm-9">{{ framework.description }}</dd>
      {% endif %}
    </dl>
  </div>
</div>

{# ── Stats badges ─────────────────────────────────────── #}
<div class="d-flex gap-2 mb-3">
  <span class="badge" style="background:var(--accent-soft);color:var(--accent);font-size:.88rem;padding:.4em .8em"><i class="bi bi-folder me-1"></i>{% blocktrans count count=stats.section_count %}{{ count }} section{% plural %}{{ count }} sections{% endblocktrans %}</span>
  <span class="badge" style="background:var(--info-soft);color:var(--info);font-size:.88rem;padding:.4em .8em"><i class="bi bi-list-check me-1"></i>{% blocktrans count count=stats.requirement_count %}{{ count }} requirement{% plural %}{{ count }} requirements{% endblocktrans %}</span>
  <span class="badge" style="background:var(--surface-muted);color:var(--text-secondary);font-size:.88rem;padding:.4em .8em"><i class="bi bi-diagram-3 me-1"></i>{% blocktrans with depth=stats.max_depth %}Max depth: {{ depth }}{% endblocktrans %}</span>
</div>

{# ── Warnings ─────────────────────────────────────────── #}
{% if warnings %}
<div class="alert alert-warning">
  <strong><i class="bi bi-exclamation-triangle me-1"></i>{% trans "Warnings:" %}</strong>
  <ul class="mb-0 mt-1">
    {% for w in warnings %}
    <li>{{ w }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{# ── Tree view ────────────────────────────────────────── #}
<div class="card mb-3">
  <div class="card-header">{% trans "Tree view" %}</div>
  <div class="card-body p-2">
    <ul class="list-unstyled mb-0">
      {% for section in sections %}
      {% if not section.is_virtual %}
      <li style="padding-left: {{ section.depth|add:"-1"|floatformat:"0" }}rem;" class="py-1">
        <i class="bi bi-folder text-warning me-1"></i>
        <strong>{{ section.reference }}</strong> — {{ section.name }}
        {% if section.requirements %}
        <ul class="list-unstyled ms-3 mt-1">
          {% for req in section.requirements %}
          <li class="py-1 text-muted">
            <i class="bi bi-check-square me-1"></i>
            <span style="color:var(--text-muted);font-size:.82rem">{{ req.reference }}</span> {{ req.name }}
            {% if req.type %}<span class="badge text-bg-light">{{ req.type }}</span>{% endif %}
          </li>
          {% endfor %}
        </ul>
        {% endif %}
      </li>
      {% else %}
      {# Virtual section: orphan requirements #}
      <li class="py-1">
        <i class="bi bi-exclamation-triangle text-warning me-1"></i>
        <em>{% trans "Requirements without section:" %}</em>
        <ul class="list-unstyled ms-3 mt-1">
          {% for req in section.requirements %}
          <li class="py-1 text-muted">
            <i class="bi bi-check-square me-1"></i>
            <span style="color:var(--text-muted);font-size:.82rem">{{ req.reference }}</span> {{ req.name }}
          </li>
          {% endfor %}
        </ul>
      </li>
      {% endif %}
      {% endfor %}
    </ul>
  </div>
</div>

{# ── Actions ──────────────────────────────────────────── #}
<div class="card">
  <div class="card-body">
    <form method="post" class="mt-0">
      {% csrf_token %}
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>{% if existing_framework %}{% trans "Confirm addition" %}{% else %}{% trans "Confirm import" %}{% endif %}</button>
        <a href="{% url 'compliance:framework-import' %}" class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
