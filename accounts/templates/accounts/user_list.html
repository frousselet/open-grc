{% extends "base.html" %}
{% load accounts_tags %}
{% load help_tags %}
{% load i18n %}
{% block title %}{% trans "Users â€” Open GRC" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>{% trans "Users" %}</h2>
  {% has_perm "system.users.create" as can_create %}
  {% if can_create %}
  <a href="{% url 'accounts:user-create' %}" class="btn btn-primary">{% trans "Create a user" %}</a>
  {% endif %}
</div>
{% help_modal "accounts.user_list" %}

<form method="get" class="row g-3 mb-4">
  <div class="col-md-4">
    <input type="text" name="q" class="form-control" placeholder="{% trans "Search..." %}" value="{{ request.GET.q|default:'' }}">
  </div>
  <div class="col-md-3">
    <select name="status" class="form-select">
      <option value="">{% trans "All statuses" %}</option>
      <option value="active" {% if request.GET.status == "active" %}selected{% endif %}>{% trans "Active" %}</option>
      <option value="inactive" {% if request.GET.status == "inactive" %}selected{% endif %}>{% trans "Inactive" %}</option>
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-outline-secondary w-100">{% trans "Filter" %}</button>
  </div>
</form>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th>{% trans "Name" %}</th>
          <th>{% trans "Email" %}</th>
          <th>{% trans "Job title" %}</th>
          <th>{% trans "Department" %}</th>
          <th>{% trans "Status" %}</th>
          <th>{% trans "Last login" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>
            <a href="{% url 'accounts:user-detail' u.pk %}" class="d-inline-flex align-items-center gap-2" style="color:var(--accent);text-decoration:none;font-weight:500">
              {% if u.avatar %}
              <img src="{{ u.avatar.url }}" alt="" style="width:24px;height:24px;border-radius:50%;object-fit:cover">
              {% else %}
              <span class="d-inline-flex align-items-center justify-content-center" style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),rgba(99,102,241,.15));color:var(--accent);font-size:.6875rem;font-weight:650">{{ u.display_name|truncatechars:1 }}</span>
              {% endif %}
              {{ u.display_name }}
            </a>
          </td>
          <td>{{ u.email }}</td>
          <td>{{ u.job_title|default:"-" }}</td>
          <td>{{ u.department|default:"-" }}</td>
          <td>
            {% if u.is_active %}
              {% if u.is_locked %}
              <span class="badge bg-warning text-dark">{% trans "Locked" %}</span>
              {% else %}
              <span class="badge bg-success">{% trans "Active" %}</span>
              {% endif %}
            {% else %}
            <span class="badge bg-secondary">{% trans "Inactive" %}</span>
            {% endif %}
          </td>
          <td>{{ u.last_login|date:"d/m/Y H:i"|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center py-4" style="color:var(--text-muted)">{% trans "No user found." %}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if is_paginated %}
<nav>
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&laquo;</a></li>
    {% endif %}
    <li class="page-item active"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&raquo;</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
