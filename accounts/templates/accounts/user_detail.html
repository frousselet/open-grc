{% extends "base.html" %}
{% load accounts_tags %}
{% load i18n %}
{% load help_tags %}
{% block title %}{{ account_user.display_name }} â€” Open GRC{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center gap-3">
    {% if account_user.avatar %}
    <img src="{{ account_user.avatar }}" alt="" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--border-light)">
    {% else %}
    <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),rgba(99,102,241,.15));color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.125rem;font-weight:650;">
      {{ account_user.display_name|truncatechars:1 }}
    </div>
    {% endif %}
    <h2 class="mb-0">{{ account_user.display_name }}</h2>
  </div>
  <div class="d-flex gap-2">
    {% has_perm "system.users.update" as can_edit %}
    {% if can_edit %}
    <a href="{% url 'accounts:user-update' account_user.pk %}" class="btn btn-outline-primary">{% trans "Edit" %}</a>
    {% endif %}
    <a href="{% url 'accounts:user-list' %}" class="btn btn-outline-secondary">{% trans "Back to list" %}</a>
  </div>
{% help_modal "accounts.user_detail" %}
</div>

<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#info">{% trans "Information" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#groups-tab">{% trans "Groups" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#perms-tab">{% trans "Effective permissions" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#logs-tab">{% trans "Access log" %}</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="info">
    <div class="card">
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Email" %}</dt><dd class="col-sm-9">{{ account_user.email }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "First name" %}</dt><dd class="col-sm-9">{{ account_user.first_name }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Last name" %}</dt><dd class="col-sm-9">{{ account_user.last_name }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Job title" %}</dt><dd class="col-sm-9">{{ account_user.job_title|default:"-" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Department" %}</dt><dd class="col-sm-9">{{ account_user.department|default:"-" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Phone" %}</dt><dd class="col-sm-9">{{ account_user.phone|default:"-" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Language" %}</dt><dd class="col-sm-9">{{ account_user.get_language_display }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Timezone" %}</dt><dd class="col-sm-9">{{ account_user.timezone }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Status" %}</dt>
          <dd class="col-sm-9">
            {% if account_user.is_active %}
              {% if account_user.is_locked %}
              <span class="badge bg-warning text-dark">{% trans "Locked" %}</span>
              {% else %}
              <span class="badge bg-success">{% trans "Active" %}</span>
              {% endif %}
            {% else %}
            <span class="badge bg-secondary">{% trans "Inactive" %}</span>
            {% endif %}
          </dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Last login" %}</dt><dd class="col-sm-9">{{ account_user.last_login|date:"d/m/Y H:i"|default:"-" }}</dd>
          <dt class="col-sm-3" style="color:var(--text-muted);font-size:.82rem">{% trans "Created on" %}</dt><dd class="col-sm-9">{{ account_user.created_at|date:"d/m/Y H:i" }}</dd>
        </dl>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="groups-tab">
    <div class="card">
      <div class="card-body">
        {% if groups %}
        <ul class="list-group list-group-flush">
          {% for group in groups %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{% url 'accounts:group-detail' group.pk %}" style="color:var(--accent);text-decoration:none;font-weight:500">{{ group.name }}</a>
            {% if group.is_system %}<span class="badge" style="background:var(--accent-soft);color:var(--accent);font-size:.82rem;padding:.4em .8em">{% trans "System" %}</span>{% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p style="color:var(--text-muted);font-size:.85rem" class="mb-0">{% trans "No group assigned." %}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="perms-tab">
    <div class="card">
      <div class="card-body" style="max-height: 500px; overflow-y: auto;">
        {% if permissions %}
        <ul class="list-unstyled mb-0" style="font-size: 0.85rem;">
          {% for perm in permissions %}
          <li><code>{{ perm }}</code></li>
          {% endfor %}
        </ul>
        {% else %}
        <p style="color:var(--text-muted);font-size:.85rem" class="mb-0">{% trans "No permissions." %}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="logs-tab">
    <div class="card">
      <div class="card-body">
        {% if recent_access_logs %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr><th>{% trans "Date" %}</th><th>{% trans "Event" %}</th><th>{% trans "IP" %}</th><th>{% trans "Reason" %}</th></tr></thead>
            <tbody>
              {% for log in recent_access_logs %}
              <tr>
                <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>
                <td>{{ log.get_event_type_display }}</td>
                <td>{{ log.ip_address|default:"-" }}</td>
                <td>{{ log.get_failure_reason_display|default:"-" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p style="color:var(--text-muted);font-size:.85rem" class="mb-0">{% trans "No events." %}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
