{% extends "base.html" %}
{% load accounts_tags %}
{% load i18n %}
{% load help_tags %}
{% block title %}{{ group.name }} — Open GRC{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>{{ group.name }}
    {% if group.is_system %}<span class="badge fs-6" style="background:var(--accent-soft);color:var(--accent);font-size:.82rem;padding:.4em .8em">{% trans "System" %}</span>{% endif %}
  </h2>
  <div class="d-flex gap-2">
    {% if not group.is_system %}
    {% has_perm "system.groups.update" as can_edit %}
    {% if can_edit %}
    <a href="{% url 'accounts:group-update' group.pk %}" class="btn btn-outline-primary">{% trans "Edit" %}</a>
    {% endif %}
    {% endif %}
    <a href="{% url 'accounts:group-list' %}" class="btn btn-outline-secondary">{% trans "Back to list" %}</a>
  </div>
{% help_modal "accounts.group_detail" %}
</div>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}

{% if group.description %}
<p style="color:var(--text-muted)" class="mb-4">{{ group.description }}</p>
{% endif %}

<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#perms-tab">{% trans "Permissions" %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#users-tab">{% blocktrans with count=group_users|length %}Users ({{ count }}){% endblocktrans %}</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#scopes-tab">{% trans "Scopes" %}</a></li>
</ul>

<div class="tab-content">
  <!-- Permissions Matrix -->
  <div class="tab-pane fade show active" id="perms-tab">
    <form method="post" action="{% url 'accounts:group-permissions-update' group.pk %}">
      {% csrf_token %}
      {% regroup permission_matrix by module_label as module_groups %}
      {% for module_group in module_groups %}
      <div class="card mb-3">
        <div class="card-header"><strong>{{ module_group.grouper }}</strong></div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:35%">{% trans "Feature" %}</th>
                <th class="text-center">{% trans "Create" %}</th>
                <th class="text-center">{% trans "Read" %}</th>
                <th class="text-center">{% trans "Edit" %}</th>
                <th class="text-center">{% trans "Delete" %}</th>
                <th class="text-center">{% trans "Access" %}</th>
                <th class="text-center">{% trans "Approve" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in module_group.list %}
              <tr>
                <td>{{ row.feature_label }}</td>
                {% for cell in row.cells %}
                <td class="text-center">
                  {% if cell.has_action %}
                  <input type="checkbox" name="permissions" value="{{ cell.codename }}"
                    {% if cell.checked %}checked{% endif %}
                    {% if group.is_system %}disabled{% endif %}
                    class="form-check-input">
                  {% else %}
                  <span style="color:var(--text-muted)">—</span>
                  {% endif %}
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
      {% if not group.is_system %}
      <button type="submit" class="btn btn-primary">{% trans "Save permissions" %}</button>
      {% endif %}
    </form>
  </div>

  <!-- Users -->
  <div class="tab-pane fade" id="users-tab">
    <div class="card">
      <div class="card-body">
        {% if group_users %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr><th>{% trans "Name" %}</th><th>{% trans "Email" %}</th><th></th></tr></thead>
            <tbody>
              {% for u in group_users %}
              <tr>
                <td><a href="{% url 'accounts:user-detail' u.pk %}" style="color:var(--accent);text-decoration:none;font-weight:500">{{ u.display_name }}</a></td>
                <td>{{ u.email }}</td>
                <td class="text-end">
                  {% if not group.is_system %}
                  {% has_perm "system.groups.update" as can_edit_group %}
                  {% if can_edit_group %}
                  <form method="post" action="{% url 'accounts:group-users-update' group.pk %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="remove">
                    <input type="hidden" name="user_id" value="{{ u.pk }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">{% trans "Remove" %}</button>
                  </form>
                  {% endif %}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p style="color:var(--text-muted);font-size:.85rem" class="mb-0">{% trans "No users in this group." %}</p>
        {% endif %}

        {% if not group.is_system %}
        {% has_perm "system.groups.update" as can_edit_group %}
        {% if can_edit_group and all_users %}
        <hr>
        <form method="post" action="{% url 'accounts:group-users-update' group.pk %}" class="row g-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="add">
          <div class="col-auto">
            <select name="user_id" class="form-select form-select-sm">
              {% for u in all_users %}
              <option value="{{ u.pk }}">{{ u.display_name }} ({{ u.email }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-sm btn-primary">{% trans "Add" %}</button>
          </div>
        </form>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Scopes -->
  <div class="tab-pane fade" id="scopes-tab">
    <div class="card">
      <div class="card-body">
        <p style="color:var(--text-muted);font-size:.85rem" class="mb-3">
          {% trans "If no scope is selected, members of this group have access to all scopes." %}
        </p>
        <form method="post" action="{% url 'accounts:group-scopes-update' group.pk %}">
          {% csrf_token %}
          {% if all_scopes %}
          {% for s in all_scopes %}
          <div class="form-check mb-2">
            <input type="checkbox" name="scopes" value="{{ s.pk }}"
              {% if s.pk in group_scope_ids %}checked{% endif %}
              class="form-check-input" id="scope-{{ s.pk }}">
            <label class="form-check-label" for="scope-{{ s.pk }}">
              {{ s.name }} <span class="badge text-bg-{% if s.status == 'active' %}success{% elif s.status == 'draft' %}secondary{% else %}warning{% endif %}">{{ s.get_status_display }}</span>
            </label>
          </div>
          {% endfor %}
          {% else %}
          <p style="color:var(--text-muted);font-size:.85rem">{% trans "No scopes available." %}</p>
          {% endif %}
          {% has_perm "system.groups.update" as can_edit_group %}
          {% if can_edit_group %}
          <button type="submit" class="btn btn-primary mt-3">{% trans "Save scopes" %}</button>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
