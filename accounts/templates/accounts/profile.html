{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "My profile — Open GRC" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>{% trans "My profile" %}</h2>
</div>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.remove_avatar }}
  {{ form.avatar_resized }}
  <div class="row">
    <div class="col-lg-8">

      {# ── Avatar + Identity card ──────────────────────── #}
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center gap-4">
            <div class="position-relative" style="flex-shrink:0">
              {% if user.avatar %}
              <img id="avatar-preview" src="{{ user.avatar }}" alt=""
                   style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--border-light)">
              {% else %}
              <div id="avatar-preview"
                   style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),rgba(99,102,241,.15));color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:650;border:3px solid var(--border-light)">
                {{ user.display_name|truncatechars:1 }}
              </div>
              {% endif %}
              <label for="{{ form.avatar.id_for_label }}" class="position-absolute d-flex align-items-center justify-content-center"
                     style="bottom:0;right:0;width:26px;height:26px;border-radius:50%;background:var(--accent);color:#fff;cursor:pointer;font-size:.7rem;border:2px solid var(--card-bg);transition:transform .15s"
                     title="{% trans 'Change photo' %}">
                <i class="bi bi-camera-fill"></i>
              </label>
              <div style="display:none">{{ form.avatar }}</div>
            </div>
            <div>
              <div style="font-weight:600;font-size:1.0625rem">{{ user.display_name }}</div>
              <div style="color:var(--text-muted);font-size:.8125rem">{{ user.email }}</div>
              {% if user.avatar %}
              <button type="button" id="remove-avatar-btn" class="btn btn-link btn-sm p-0 mt-1" style="font-size:.75rem;color:var(--text-muted);text-decoration:none"
                      onclick="removeAvatar()">
                <i class="bi bi-x me-1"></i>{% trans "Remove photo" %}
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {# ── Personal information ────────────────────────── #}
      <div class="card mb-4">
        <div class="card-header"><h6 class="mb-0"><i class="bi bi-person me-2" style="color:var(--accent)"></i>{% trans "Personal information" %}</h6></div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-6">
              <div class="mb-3">
                <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="invalid-feedback d-block">{{ form.first_name.errors.0 }}</div>{% endif %}
              </div>
            </div>
            <div class="col-sm-6">
              <div class="mb-3">
                <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="invalid-feedback d-block">{{ form.last_name.errors.0 }}</div>{% endif %}
              </div>
            </div>
          </div>
          <div class="mb-0">
            <label for="{{ form.phone.id_for_label }}" class="form-label">{{ form.phone.label }}</label>
            {{ form.phone }}
            {% if form.phone.errors %}<div class="invalid-feedback d-block">{{ form.phone.errors.0 }}</div>{% endif %}
          </div>
        </div>
      </div>

      {# ── Preferences ─────────────────────────────────── #}
      <div class="card mb-4">
        <div class="card-header"><h6 class="mb-0"><i class="bi bi-gear me-2" style="color:var(--accent)"></i>{% trans "Preferences" %}</h6></div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-6">
              <div class="mb-3 mb-sm-0">
                <label for="{{ form.language.id_for_label }}" class="form-label">{{ form.language.label }}</label>
                {{ form.language }}
                {% if form.language.errors %}<div class="invalid-feedback d-block">{{ form.language.errors.0 }}</div>{% endif %}
              </div>
            </div>
            <div class="col-sm-6">
              <div class="mb-0">
                <label for="{{ form.timezone.id_for_label }}" class="form-label">{{ form.timezone.label }}</label>
                {{ form.timezone }}
                {% if form.timezone.errors %}<div class="invalid-feedback d-block">{{ form.timezone.errors.0 }}</div>{% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      {# ── Actions ─────────────────────────────────────── #}
      <div class="d-flex gap-2 mb-4">
        <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
        <a href="{% url 'accounts:password-change' %}" class="btn btn-outline-secondary"><i class="bi bi-shield-lock me-1"></i>{% trans "Change password" %}</a>
      </div>
    </div>

    <div class="col-lg-4">
      {# ── Groups ──────────────────────────────────────── #}
      <div class="card mb-4">
        <div class="card-header"><h6 class="mb-0"><i class="bi bi-people me-2" style="color:var(--accent)"></i>{% trans "My groups" %}</h6></div>
        <div class="card-body">
          {% if groups %}
          <div class="d-flex flex-wrap gap-1">
            {% for group in groups %}
            <span class="badge" style="background:var(--accent-soft);color:var(--accent);font-size:.82rem;padding:.4em .8em">{{ group.name }}</span>
            {% endfor %}
          </div>
          {% else %}
          <p style="color:var(--text-muted);font-size:.85rem" class="mb-0">{% trans "No group assigned." %}</p>
          {% endif %}
        </div>
      </div>

      {# ── Permissions ─────────────────────────────────── #}
      <div class="card mb-4">
        <div class="card-header"><h6 class="mb-0"><i class="bi bi-key me-2" style="color:var(--accent)"></i>{% trans "Effective permissions" %}</h6></div>
        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
          {% if permissions %}
          <ul class="list-unstyled mb-0" style="font-size: 0.85rem;">
            {% for perm in permissions %}
            <li><code>{{ perm }}</code></li>
            {% endfor %}
          </ul>
          {% else %}
          <p style="color:var(--text-muted);font-size:.85rem" class="mb-0">{% trans "No permissions." %}</p>
          {% endif %}
        </div>
      </div>

      {# ── Passkeys ──────────────────────────────────── #}
      <div class="card" id="passkey-card" style="display:none">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-fingerprint me-2" style="color:var(--accent)"></i>{% trans "Passkeys" %}</h6>
          <button type="button" class="btn btn-sm btn-outline-primary" id="register-passkey-btn" onclick="registerPasskey()">
            <i class="bi bi-plus-lg me-1"></i>{% trans "Add" %}
          </button>
        </div>
        <div class="card-body" id="passkey-list">
          {% include "accounts/partials/passkey_list.html" %}
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_js %}
{% include "includes/image_resize.html" %}
<script>
document.getElementById('{{ form.avatar.id_for_label }}').addEventListener('change', function(e) {
  var file = e.target.files[0];
  if (!file) return;
  document.getElementById('id_remove_avatar').value = '';
  resizeImageFile(file, 128, function(dataUri) {
    document.getElementById('id_avatar_resized').value = dataUri;
    var el = document.getElementById('avatar-preview');
    if (el.tagName === 'IMG') {
      el.src = dataUri;
    } else {
      var img = document.createElement('img');
      img.id = 'avatar-preview';
      img.src = dataUri;
      img.style.cssText = 'width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--border-light)';
      el.parentNode.replaceChild(img, el);
    }
  });
});

function removeAvatar() {
  document.getElementById('id_remove_avatar').value = 'True';
  document.getElementById('id_avatar_resized').value = '';
  var el = document.getElementById('avatar-preview');
  var div = document.createElement('div');
  div.id = 'avatar-preview';
  div.style.cssText = 'width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),rgba(99,102,241,.15));color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:650;border:3px solid var(--border-light)';
  div.textContent = '{{ user.display_name|truncatechars:1 }}';
  el.parentNode.replaceChild(div, el);
  var btn = document.getElementById('remove-avatar-btn');
  if (btn) btn.style.display = 'none';
}

/* ── Passkey management ─────────────────────────── */
(function() {
  if (!window.PublicKeyCredential) return;
  document.getElementById('passkey-card').style.display = '';
})();

function base64urlToBytes(b64) {
  var s = b64.replace(/-/g, '+').replace(/_/g, '/');
  while (s.length % 4) s += '=';
  var raw = atob(s);
  var arr = new Uint8Array(raw.length);
  for (var i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
  return arr;
}

function bytesToBase64url(buf) {
  var bytes = new Uint8Array(buf);
  var s = '';
  for (var i = 0; i < bytes.length; i++) s += String.fromCharCode(bytes[i]);
  return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function getCsrfTokenPasskey() {
  var el = document.querySelector('[name=csrfmiddlewaretoken]');
  if (el) return el.value;
  var m = document.cookie.match(/csrftoken=([^;]+)/);
  return m ? m[1] : '';
}

async function registerPasskey() {
  var name = prompt('{% trans "Name for this passkey:" %}', 'Passkey');
  if (!name) return;

  var btn = document.getElementById('register-passkey-btn');
  btn.disabled = true;

  try {
    var beginResp = await fetch('{% url "accounts:passkey-register-begin" %}', {
      method: 'POST',
      headers: {'X-CSRFToken': getCsrfTokenPasskey(), 'Content-Type': 'application/json'},
      body: '{}'
    });
    if (!beginResp.ok) throw new Error('Server error');
    var options = await beginResp.json();

    // Decode binary fields
    options.publicKey.challenge = base64urlToBytes(options.publicKey.challenge);
    options.publicKey.user.id = base64urlToBytes(options.publicKey.user.id);
    if (options.publicKey.excludeCredentials) {
      options.publicKey.excludeCredentials = options.publicKey.excludeCredentials.map(function(c) {
        return Object.assign({}, c, {id: base64urlToBytes(c.id)});
      });
    }

    var cred = await navigator.credentials.create(options);

    var credential = {
      id: cred.id,
      rawId: bytesToBase64url(cred.rawId),
      type: cred.type,
      response: {
        attestationObject: bytesToBase64url(cred.response.attestationObject),
        clientDataJSON: bytesToBase64url(cred.response.clientDataJSON)
      }
    };

    var completeResp = await fetch('{% url "accounts:passkey-register-complete" %}', {
      method: 'POST',
      headers: {'X-CSRFToken': getCsrfTokenPasskey(), 'Content-Type': 'application/json'},
      body: JSON.stringify({name: name, credential: credential})
    });
    var result = await completeResp.json();
    if (completeResp.ok && result.status === 'ok') {
      refreshPasskeyList();
    } else {
      alert(result.error || '{% trans "Registration failed." %}');
    }
  } catch (e) {
    if (e.name !== 'NotAllowedError') {
      alert(e.message || '{% trans "Registration failed." %}');
    }
  } finally {
    btn.disabled = false;
  }
}

async function deletePasskey(id, name) {
  if (!confirm('{% trans "Delete passkey" %} "' + name + '" ?')) return;

  try {
    var resp = await fetch('/accounts/passkeys/' + id + '/delete/', {
      method: 'POST',
      headers: {'X-CSRFToken': getCsrfTokenPasskey(), 'Content-Type': 'application/json'},
      body: '{}'
    });
    if (resp.ok) {
      refreshPasskeyList();
    } else {
      var result = await resp.json();
      alert(result.error || '{% trans "Deletion failed." %}');
    }
  } catch (e) {
    alert(e.message || '{% trans "Deletion failed." %}');
  }
}

async function refreshPasskeyList() {
  try {
    var resp = await fetch('{% url "accounts:passkey-list" %}');
    var data = await resp.json();
    document.getElementById('passkey-list').innerHTML = data.html;
  } catch (e) {
    window.location.reload();
  }
}
</script>
{% endblock %}
