{% load static %}
{% load accounts_tags %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Open GRC{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.bootstrap5.min.css"
        rel="stylesheet">
  <style>
    /* ── Design tokens ────────────────────────────────── */
    :root {
      --sidebar-w: 264px;
      --sidebar-inset: .875rem;
      --radius-xs: .375rem;
      --radius-sm: .5rem;
      --radius-md: .75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
      --radius-2xl: 1.5rem;
      --shadow-xs: 0 1px 2px rgba(0,0,0,.03);
      --shadow-sm: 0 1px 3px rgba(0,0,0,.05), 0 1px 2px rgba(0,0,0,.03);
      --shadow-md: 0 4px 16px rgba(0,0,0,.06), 0 1px 3px rgba(0,0,0,.04);
      --shadow-lg: 0 12px 32px rgba(0,0,0,.08), 0 4px 8px rgba(0,0,0,.04);
      --shadow-xl: 0 20px 48px rgba(0,0,0,.1), 0 8px 16px rgba(0,0,0,.05);
      --shadow-glow: 0 0 0 1px rgba(99,102,241,.08), 0 4px 16px rgba(99,102,241,.08);
      --surface: #ffffff;
      --surface-raised: #ffffff;
      --surface-muted: #f8fafc;
      --surface-subtle: #f1f5f9;
      --surface-glass: rgba(255,255,255,.78);
      --bg-page: #f0f4f8;
      --border-light: #e2e8f0;
      --border-subtle: #edf2f7;
      --border-glass: rgba(255,255,255,.5);
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --text-xs: #a0aec0;
      --accent: #6366f1;
      --accent-soft: #eef2ff;
      --accent-hover: #4f46e5;
      --accent-glow: rgba(99,102,241,.2);
      --success: #10b981;
      --success-soft: #ecfdf5;
      --warning: #f59e0b;
      --warning-soft: #fffbeb;
      --danger: #ef4444;
      --danger-soft: #fef2f2;
      --info: #06b6d4;
      --info-soft: #ecfeff;
      --transition-fast: .15s cubic-bezier(.4,0,.2,1);
      --transition-normal: .25s cubic-bezier(.4,0,.2,1);
      --transition-spring: .35s cubic-bezier(.34,1.56,.64,1);
      --text-sidebar-sub: #8494a7;
      --ease-out-expo: cubic-bezier(.16,1,.3,1);
    }

    [data-bs-theme="dark"] {
      --surface: #1a2332;
      --surface-raised: #1e293b;
      --surface-muted: #0f172a;
      --surface-subtle: #162032;
      --surface-glass: rgba(26,35,50,.82);
      --bg-page: #0c1220;
      --border-light: #2d3d50;
      --border-subtle: #1e293b;
      --border-glass: rgba(255,255,255,.06);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --text-xs: #4a5568;
      --accent: #818cf8;
      --accent-soft: rgba(99,102,241,.1);
      --accent-hover: #a5b4fc;
      --accent-glow: rgba(129,140,248,.15);
      --success-soft: rgba(16,185,129,.1);
      --warning-soft: rgba(245,158,11,.1);
      --danger-soft: rgba(239,68,68,.1);
      --info-soft: rgba(6,182,212,.1);
      --shadow-xs: 0 1px 2px rgba(0,0,0,.16);
      --shadow-sm: 0 1px 3px rgba(0,0,0,.2);
      --shadow-md: 0 4px 16px rgba(0,0,0,.24);
      --shadow-lg: 0 12px 32px rgba(0,0,0,.32);
      --shadow-xl: 0 20px 48px rgba(0,0,0,.4);
      --shadow-glow: 0 0 0 1px rgba(129,140,248,.1), 0 4px 16px rgba(129,140,248,.06);
      --text-sidebar-sub: #64748b;
    }
    [data-bs-theme="dark"] .sidebar-link,
    [data-bs-theme="dark"] .sidebar-collapse-btn { color: #e2e8f0; }
    [data-bs-theme="dark"] .sidebar-link i,
    [data-bs-theme="dark"] .sidebar-collapse-btn i:first-child { color: #94a3b8; }
    [data-bs-theme="dark"] .sidebar-link.sidebar-sub { color: #94a3b8; }

    /* ── Global ────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; }
    html { font-size: 16px; scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    }
    ::selection { background: var(--accent-soft); color: var(--accent); }

    /* ── Typography ────────────────────────────────────── */
    h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -.02em; color: var(--text-primary); line-height: 1.3; }
    h2 { font-size: 1.25rem; font-weight: 650; letter-spacing: -.015em; color: var(--text-primary); line-height: 1.35; }
    h3 { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }
    h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }
    h5 { font-size: .875rem; font-weight: 600; color: var(--text-primary); line-height: 1.4; }
    h6 { font-size: .8125rem; font-weight: 600; color: var(--text-secondary); line-height: 1.5; }
    .display-4 { font-size: 2rem; font-weight: 700; letter-spacing: -.03em; line-height: 1.1; }
    .display-6 { font-size: 1.6rem; font-weight: 700; letter-spacing: -.025em; line-height: 1.15; }
    small, .small { font-size: .8125rem; }
    .text-xs { font-size: .75rem; }

    /* ── Sidebar ───────────────────────────────────────── */
    .sidebar {
      position: fixed;
      top: var(--sidebar-inset);
      left: var(--sidebar-inset);
      bottom: var(--sidebar-inset);
      width: var(--sidebar-w);
      background: var(--surface-raised);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xs);
      overflow-y: auto;
      z-index: 1040;
      display: flex;
      flex-direction: column;
      transition: transform .3s var(--ease-out-expo);
    }
    .sidebar::-webkit-scrollbar { width: 3px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; margin: 8px 0; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    .sidebar-brand {
      padding: 1.25rem 1.25rem 1.125rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-brand a {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--accent);
      text-decoration: none;
      letter-spacing: -.025em;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .sidebar-brand-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
      color: #fff;
      font-size: .85rem;
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    .sidebar-body {
      flex: 1;
      padding: .5rem 0;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 1.375rem 1.25rem .5rem;
      font-size: .625rem;
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--text-muted);
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: .625rem;
      padding: .4375rem 1.25rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: .8125rem;
      font-weight: 450;
      border-radius: 0;
      transition: all var(--transition-fast);
      margin: 0;
      position: relative;
    }
    .sidebar-link:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .sidebar-link.active {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }
    .sidebar-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: .375rem;
      bottom: .375rem;
      width: 3px;
      border-radius: 0 3px 3px 0;
      background: var(--accent);
    }
    .sidebar-link i {
      font-size: .9375rem;
      width: 1.25rem;
      text-align: center;
      color: var(--text-muted);
      transition: color var(--transition-fast);
    }
    .sidebar-link:hover i,
    .sidebar-link.active i { color: var(--accent); }
    .sidebar-sub { padding-left: 3.125rem; font-size: .8125rem; color: var(--text-sidebar-sub); }

    .sidebar-body .collapse {
      position: relative;
    }
    .sidebar-body .collapse::before {
      content: '';
      position: absolute;
      left: 1.875rem;
      top: .1875rem;
      bottom: .1875rem;
      width: 1px;
      background: var(--border-light);
      border-radius: 1px;
      opacity: .6;
    }

    .sidebar-collapse-btn {
      display: flex;
      align-items: center;
      gap: .625rem;
      padding: .4375rem 1.25rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: .8125rem;
      font-weight: 450;
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .sidebar-collapse-btn:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .sidebar-collapse-btn:hover i:first-child { color: var(--accent); }
    .sidebar-collapse-btn i.bi-chevron-down {
      margin-left: auto;
      font-size: .5625rem;
      transition: transform .25s var(--ease-out-expo);
      color: var(--text-muted);
    }
    .sidebar-collapse-btn[aria-expanded="true"] i.bi-chevron-down {
      transform: rotate(180deg);
    }
    .sidebar-collapse-btn i:first-child {
      font-size: .9375rem;
      width: 1.25rem;
      text-align: center;
      color: var(--text-muted);
    }

    .sidebar-footer {
      border-top: 1px solid var(--border-light);
      padding: .875rem 1.25rem;
    }
    .sidebar-footer .dropdown-toggle {
      color: var(--text-secondary);
      font-size: .8125rem;
      font-weight: 500;
      transition: color var(--transition-fast);
    }
    .sidebar-footer .dropdown-toggle:hover { color: var(--accent); }

    /* ── Main content ──────────────────────────────────── */
    .main-content {
      margin-left: calc(var(--sidebar-w) + var(--sidebar-inset) * 2);
      padding: 2.5rem 3rem 4rem;
      min-height: 100vh;
      background: var(--bg-page);
    }

    /* ── Vertical rhythm ──────────────────────────────── */
    .main-content h1,
    .main-content h2 { margin-bottom: 1.5rem; }
    .main-content .d-flex > h1,
    .main-content .d-flex > h2 { margin-bottom: 0; }
    .main-content h3,
    .main-content h5.card-title { margin-bottom: 1rem; }
    .main-content hr {
      margin: 2.5rem 0;
      border: none;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border-light) 20%, var(--border-light) 80%, transparent);
    }
    .main-content .card { margin-bottom: 1.5rem; }
    .main-content .row.g-3 { --bs-gutter-y: 1.25rem; }
    .main-content .row.g-4 { --bs-gutter-y: 1.5rem; }
    .main-content .table-responsive { margin-top: .75rem; margin-bottom: 2rem; }
    .main-content form.row { margin-bottom: 2rem; }
    .main-content .help-banner { margin-bottom: 1.5rem; }
    .main-content > .container-xl > .d-flex:first-child { margin-bottom: 1.75rem; }
    .main-content .pagination { margin-top: 1.25rem; }
    .main-content .alert { margin-bottom: 1.5rem; }
    .main-content .mb-3 { margin-bottom: 1.25rem !important; }
    .main-content .mb-4 { margin-bottom: 2rem !important; }

    /* ── Cards — Soft UI ───────────────────────────────── */
    .card {
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: var(--surface-raised);
      box-shadow: var(--shadow-xs);
      transition: box-shadow .3s var(--ease-out-expo), transform .3s var(--ease-out-expo);
    }
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    .card-body { padding: 1.375rem 1.5rem; }
    .card-title { font-weight: 600; color: var(--text-primary); font-size: .875rem; }

    /* ── Stat cards (bento) ────────────────────────────── */
    .stat-card {
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: var(--surface-raised);
      box-shadow: var(--shadow-xs);
      padding: 1.25rem 1.375rem;
      transition: all .3s var(--ease-out-expo);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
      opacity: 0;
      transition: opacity .3s var(--ease-out-expo);
    }
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
      border-color: var(--border-subtle);
    }
    .stat-card:hover::before { opacity: 1; }
    .stat-card-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.375rem;
      height: 2.375rem;
      border-radius: var(--radius-md);
      font-size: 1.0625rem;
      margin-bottom: .75rem;
      transition: transform .3s var(--ease-out-expo);
    }
    .stat-card:hover .stat-card-icon { transform: scale(1.05); }
    .stat-card-icon.accent { background: var(--accent-soft); color: var(--accent); }
    .stat-card-icon.success { background: var(--success-soft); color: var(--success); }
    .stat-card-icon.warning { background: var(--warning-soft); color: var(--warning); }
    .stat-card-icon.danger { background: var(--danger-soft); color: var(--danger); }
    .stat-card-icon.info { background: var(--info-soft); color: var(--info); }
    .stat-card-label {
      font-size: .75rem;
      font-weight: 550;
      color: var(--text-muted);
      margin-bottom: .375rem;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .stat-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -.025em;
      color: var(--text-primary);
      line-height: 1.15;
      font-variant-numeric: tabular-nums;
    }
    .stat-card-footer {
      margin-top: auto;
      padding-top: .75rem;
    }
    .stat-card-link {
      font-size: .78rem;
      font-weight: 500;
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      transition: gap .2s var(--ease-out-expo), color var(--transition-fast);
    }
    .stat-card-link:hover { gap: .4375rem; color: var(--accent-hover); }
    .stat-card-link::after { content: '\2192'; font-size: .8125rem; transition: transform .2s var(--ease-out-expo); }
    .stat-card-link:hover::after { transform: translateX(1px); }

    /* ── Tables ────────────────────────────────────────── */
    .table {
      --bs-table-bg: transparent;
      font-size: .8125rem;
    }
    .table > thead > tr > th {
      font-size: .6875rem;
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border-light);
      padding: .75rem .875rem;
      background: transparent;
      white-space: nowrap;
    }
    .table > thead.table-dark {
      --bs-table-bg: transparent;
      --bs-table-color: var(--text-muted);
      --bs-table-border-color: var(--border-light);
      font-weight: 600;
    }
    .table > thead.table-dark > tr > th {
      color: var(--text-muted);
      background: transparent;
    }
    .table > tbody > tr {
      transition: background var(--transition-fast);
    }
    .table > tbody > tr:hover {
      background: var(--accent-soft) !important;
    }
    .table > :not(caption) > * > * {
      padding: .6875rem .875rem;
      border-bottom-color: var(--border-light);
    }
    .table-striped > tbody > tr:nth-of-type(odd) > * {
      --bs-table-striped-bg: transparent;
    }
    .table > tbody > tr > td { vertical-align: middle; }

    /* ── Buttons ───────────────────────────────────────── */
    .btn {
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: .8125rem;
      padding: .4375rem 1rem;
      transition: all var(--transition-fast);
      letter-spacing: .005em;
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 1px 2px var(--accent-glow);
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px var(--accent-glow);
    }
    .btn-outline-primary {
      color: var(--accent);
      border-color: var(--accent);
    }
    .btn-outline-primary:hover {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 4px 12px var(--accent-glow);
    }
    .btn-outline-secondary {
      color: var(--text-secondary);
      border-color: var(--border-light);
    }
    .btn-outline-secondary:hover {
      background: var(--surface-muted);
      border-color: var(--border-light);
      color: var(--text-primary);
    }
    .btn-sm { padding: .3125rem .75rem; font-size: .78rem; }
    .btn-danger { box-shadow: 0 1px 2px rgba(239,68,68,.15); }
    .btn-danger:hover { box-shadow: 0 4px 12px rgba(239,68,68,.2); }
    .btn-success { box-shadow: 0 1px 2px rgba(16,185,129,.15); }

    /* ── Badges ────────────────────────────────────────── */
    .badge {
      font-weight: 550;
      font-size: .6875rem;
      padding: .25em .5625em;
      border-radius: var(--radius-xs);
      letter-spacing: .01em;
      line-height: 1.5;
    }

    /* ── Tabs ──────────────────────────────────────────── */
    .nav-tabs {
      border-bottom: 1px solid var(--border-light);
      gap: .125rem;
    }
    .nav-tabs .nav-link {
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      color: var(--text-muted);
      font-weight: 500;
      font-size: .8125rem;
      padding: .625rem 1rem;
      transition: all var(--transition-fast);
      border-radius: 0;
    }
    .nav-tabs .nav-link:hover {
      color: var(--accent);
      border-bottom-color: rgba(99,102,241,.3);
      background: transparent;
    }
    .nav-tabs .nav-link.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: transparent;
      font-weight: 600;
    }

    /* ── Alerts ────────────────────────────────────────── */
    .alert {
      border-radius: var(--radius-md);
      border: 1px solid;
      font-size: .8125rem;
      padding: .875rem 1.125rem;
    }
    .alert-danger {
      background: var(--danger-soft);
      border-color: rgba(239,68,68,.15);
      color: var(--danger);
    }
    .alert-warning {
      background: var(--warning-soft);
      border-color: rgba(245,158,11,.15);
      color: #92400e;
    }
    [data-bs-theme="dark"] .alert-warning { color: var(--warning); }
    .alert-success {
      background: var(--success-soft);
      border-color: rgba(16,185,129,.15);
      color: #065f46;
    }
    [data-bs-theme="dark"] .alert-success { color: var(--success); }
    .alert-info {
      background: var(--info-soft);
      border-color: rgba(6,182,212,.15);
      color: #155e75;
    }
    [data-bs-theme="dark"] .alert-info { color: var(--info); }

    /* ── Forms ─────────────────────────────────────────── */
    .form-control, .form-select {
      border-radius: var(--radius-sm);
      border-color: var(--border-light);
      font-size: .8125rem;
      padding: .5rem .875rem;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      color: var(--text-primary);
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .form-control::placeholder { color: var(--text-muted); opacity: .7; }
    .form-label {
      font-size: .78rem;
      font-weight: 550;
      color: var(--text-secondary);
      margin-bottom: .375rem;
    }
    .form-text { font-size: .75rem; color: var(--text-muted); }
    .form-check-input:checked {
      background-color: var(--accent);
      border-color: var(--accent);
    }
    .form-check-input:focus {
      box-shadow: 0 0 0 3px var(--accent-glow);
      border-color: var(--accent);
    }

    /* ── Progress bars ─────────────────────────────────── */
    .progress {
      border-radius: 100px;
      background: var(--surface-muted);
      overflow: hidden;
      height: .5rem;
    }
    .progress-bar {
      border-radius: 100px;
      font-weight: 600;
      font-size: .6875rem;
      transition: width .6s var(--ease-out-expo);
    }

    /* ── Pagination ────────────────────────────────────── */
    .page-link {
      border-radius: var(--radius-sm);
      font-size: .78rem;
      font-weight: 500;
      border-color: var(--border-light);
      color: var(--text-secondary);
      margin: 0 .125rem;
      padding: .375rem .75rem;
      transition: all var(--transition-fast);
    }
    .page-link:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .page-item.active .page-link {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    /* ── Dropdowns ─────────────────────────────────────── */
    .dropdown-menu {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-xl);
      padding: .375rem;
      font-size: .8125rem;
      animation: dropdownFade .15s var(--ease-out-expo);
    }
    @keyframes dropdownFade {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .dropdown-item {
      border-radius: var(--radius-xs);
      padding: .4375rem .75rem;
      font-size: .8125rem;
      transition: all var(--transition-fast);
    }
    .dropdown-item:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* ── Help banner ──────────────────────────────────── */
    .help-banner {
      background: var(--surface-muted);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
    }

    /* ── Hero section ─────────────────────────────────── */
    .hero-section {
      background: linear-gradient(135deg, #4f46e5 0%, #6d28d9 50%, #7c3aed 100%);
      color: #fff;
      border-radius: var(--radius-xl);
      padding: 1.75rem 2rem;
      box-shadow: 0 4px 24px rgba(79,70,229,.2), 0 12px 40px rgba(124,58,237,.12);
      position: relative;
      overflow: hidden;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 50%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,.06) 0%, transparent 70%);
      pointer-events: none;
    }
    [data-bs-theme="dark"] .hero-section {
      background: linear-gradient(135deg, #312e81 0%, #4c1d95 50%, #3730a3 100%);
      box-shadow: 0 4px 24px rgba(55,48,163,.3), 0 12px 40px rgba(76,29,149,.15);
    }
    .hero-section .progress {
      background: rgba(255,255,255,.15);
      height: 1.25rem;
    }
    .hero-section .progress-bar { font-size: .75rem; }
    .hero-section .progress { height: 1.125rem; border-radius: 100px; }

    /* ── Section header ───────────────────────────────── */
    .section-header {
      display: flex;
      align-items: center;
      gap: .625rem;
      margin-bottom: 1.25rem;
    }
    .section-header-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-sm);
      font-size: .875rem;
    }
    .section-header h2 { margin-bottom: 0; }

    /* ── Reference codes ──────────────────────────────── */
    .ref {
      font-family: 'SFMono-Regular', 'Menlo', 'Consolas', 'Liberation Mono', monospace;
      font-size: .78rem;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: -.01em;
    }

    /* ── Filter chips ─────────────────────────────────── */
    .filter-chip {
      display: inline-flex;
      align-items: center;
      padding: .3125rem .875rem;
      font-size: .78rem;
      font-weight: 500;
      border-radius: 100px;
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: var(--surface);
      text-decoration: none;
      transition: all var(--transition-fast);
      gap: .375rem;
    }
    .filter-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }
    .filter-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px var(--accent-glow);
    }
    .filter-chip.active-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: #fff;
      box-shadow: 0 2px 8px rgba(239,68,68,.2);
    }
    .filter-chip.active-warning {
      background: var(--warning);
      border-color: var(--warning);
      color: #fff;
      box-shadow: 0 2px 8px rgba(245,158,11,.2);
    }

    /* ── Tom Select overrides ─────────────────────────── */
    .ts-wrapper.multi .ts-control > .item {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-xs);
      font-size: .78rem;
      padding: .125rem .5rem;
    }
    .ts-wrapper .ts-control {
      border-color: var(--border-light);
      border-radius: var(--radius-sm);
      font-size: .8125rem;
      padding: .375rem .625rem;
    }
    .ts-wrapper.focus .ts-control {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .ts-dropdown {
      border-color: var(--border-light);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      margin-top: .25rem;
    }
    .ts-dropdown .active {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .ts-dropdown .option {
      padding: .4375rem .75rem;
      border-radius: var(--radius-xs);
      font-size: .8125rem;
    }
    .ts-dropdown .create {
      color: var(--accent);
    }
    [data-bs-theme="dark"] .ts-wrapper .ts-control {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border-light);
    }
    [data-bs-theme="dark"] .ts-dropdown {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border-light);
    }
    [data-bs-theme="dark"] .ts-dropdown .option {
      color: var(--text-primary);
    }

    /* ── Smooth focus ring for accessibility ─────────── */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: var(--radius-xs);
    }

    /* ── Scrollbar global ─────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ── Mobile ────────────────────────────────────────── */
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.3);
      z-index: 1035;
      transition: opacity .25s var(--ease-out-expo);
    }
    /* Mobile menu toggle button */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: .75rem;
      left: .75rem;
      z-index: 1045;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: var(--surface-raised);
      box-shadow: var(--shadow-xs);
      color: var(--text-secondary);
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: top .3s var(--ease-out-expo), left .3s var(--ease-out-expo),
                  background .2s ease, border-color .2s ease, box-shadow .2s ease,
                  transform .15s ease;
      padding: 0;
    }
    .mobile-menu-toggle:active {
      transform: scale(.92);
      background: var(--surface-muted);
    }
    /* When sidebar is open, integrate the close button inside the sidebar header */
    body.sidebar-open .mobile-menu-toggle {
      top: calc(var(--sidebar-inset) + .9375rem);
      left: calc(var(--sidebar-inset) + .25rem);
      background: transparent;
      border-color: transparent;
      box-shadow: none;
      color: var(--text-muted);
    }
    body.sidebar-open .mobile-menu-toggle:active {
      background: var(--surface-subtle);
    }
    /* Animated hamburger icon */
    .hamburger-icon {
      width: 18px;
      height: 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .hamburger-icon span {
      display: block;
      height: 2px;
      width: 100%;
      background: currentColor;
      border-radius: 2px;
      transition: transform .3s var(--ease-out-expo), opacity .2s var(--ease-out-expo);
      transform-origin: center;
    }
    body.sidebar-open .hamburger-icon span:nth-child(1) {
      transform: translateY(6px) rotate(45deg);
    }
    body.sidebar-open .hamburger-icon span:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }
    body.sidebar-open .hamburger-icon span:nth-child(3) {
      transform: translateY(-6px) rotate(-45deg);
    }
    @media (max-width: 991.98px) {
      html { overflow-x: hidden; }
      .sidebar {
        transform: translateX(calc(-100% - var(--sidebar-inset)));
        width: calc(100vw - var(--sidebar-inset) * 2);
        max-width: var(--sidebar-w);
      }
      .sidebar.show { transform: translateX(0); }
      .sidebar.show .sidebar-brand { padding-left: 3rem; }
      .sidebar-backdrop.show { display: block; }
      .mobile-menu-toggle { display: flex; }
      .main-content { margin-left: 0; padding: 4.5rem 1rem 3.5rem; }
      .main-content h1 { font-size: 1.25rem; }
      .main-content h2 { font-size: 1.0625rem; }
      .main-content hr { margin: 1.5rem 0; }

      /* Stat cards: compact on mobile */
      .stat-card { padding: 1rem 1.125rem; }
      .stat-card-value { font-size: 1.5rem; }
      .stat-card-icon { width: 2rem; height: 2rem; font-size: .9375rem; margin-bottom: .5rem; }
      .stat-card::before { display: none; }

      /* Hero section responsive */
      .hero-section { padding: 1.25rem 1.125rem; }
      .hero-section::before { display: none; }
      .hero-section .display-4 { font-size: 1.5rem; }
      .hero-section h2 { font-size: 1.0625rem; }
      .hero-section p { font-size: .78rem !important; }

      /* Cards compact */
      .card-body { padding: 1rem 1.125rem; }

      /* Tables scroll hint */
      .table-responsive { -webkit-overflow-scrolling: touch; }

      /* Buttons touch-friendly */
      .btn { min-height: 2.5rem; }
      .btn-sm { min-height: 2rem; }

      /* Section headers compact */
      .section-header { margin-bottom: 1rem; }
      .section-header h2 { font-size: 1rem; }
    }
    @media (max-width: 575.98px) {
      .main-content { padding: 4.5rem .75rem 2.5rem; }

      /* Stack stat cards nicely on very small screens */
      .stat-card { padding: .875rem 1rem; }
      .stat-card-value { font-size: 1.3125rem; }

      /* Risk matrix: allow horizontal scroll */
      .risk-matrix-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }

      .filter-chip { font-size: .75rem; padding: .25rem .625rem; }
    }
    @media (min-width: 992px) and (max-width: 1399.98px) {
      .main-content { padding: 2.5rem 2rem 3.5rem; }
    }
    /* ── Scope tree widget ──────────────────────────── */
    .scope-tree-label:hover { background: var(--surface-muted); }
    .scope-tree-node.hidden { display: none; }
    .scope-tree-node.collapsed-child { display: none; }
    .scope-tree-toggle .bi { transition: transform .2s ease; }
    .scope-tree-toggle.collapsed .bi { transform: rotate(-90deg); }
    .scope-tree-label input:checked ~ .scope-tree-name { font-weight: 600; color: var(--accent) !important; }
    .scope-tree-locked .scope-tree-label { opacity: .55; cursor: default; }
    .scope-tree-locked .scope-tree-label input { cursor: default; }

    /* ── Scope breadcrumb pills ──────────────────────── */
    .scope-crumb { display: inline-flex; align-items: center; flex-wrap: wrap; background: var(--accent-soft); color: var(--accent); border-radius: 999px; padding: .15em .65em; font-size: .625rem; font-weight: 500; line-height: 1.4; vertical-align: middle; gap: .1em .3em; margin-bottom: .2em; }
    .scope-crumb-sep { opacity: .35; font-weight: 400; }
    .scope-crumb-seg { opacity: .55; white-space: nowrap; }
    .scope-crumb-leaf { opacity: 1; font-weight: 650; }

    /* ── Scope count popover (tables) ─────────────── */
    .scope-pop-wrap { position: relative; display: inline-block; }
    .scope-pop-btn { background: var(--accent-soft); color: var(--accent); border: 0; border-radius: 999px; padding: .15em .55em; font-size: .75rem; font-weight: 600; cursor: pointer; white-space: nowrap; line-height: 1.4; transition: background .15s; }
    .scope-pop-btn:hover { background: color-mix(in srgb, var(--accent) 20%, var(--accent-soft)); }
    .scope-pop-btn .bi { font-size: .65rem; }
    .scope-pop-panel { display: none; position: absolute; z-index: 1050; left: 0; top: calc(100% + 4px); background: var(--surface); border: 1px solid var(--border-light); border-radius: var(--radius-sm); padding: .5rem .6rem; box-shadow: 0 4px 16px rgba(0,0,0,.12); min-width: max-content; max-width: 360px; }
    .scope-pop-panel.show { display: flex; flex-wrap: wrap; gap: .3em; align-items: center; }
  </style>
  <script>
    document.addEventListener('click', function() {
      document.querySelectorAll('.scope-pop-panel.show').forEach(function(p) { p.classList.remove('show'); });
    });
    (function(){
      var m = window.matchMedia('(prefers-color-scheme: dark)');
      function apply(dark) {
        document.documentElement.setAttribute('data-bs-theme', dark ? 'dark' : 'light');
      }
      apply(m.matches);
      m.addEventListener('change', function(e) { apply(e.matches); });
    })();
  </script>
  {% block extra_css %}{% endblock %}
</head>
<body>
  {% block layout %}
  {# ── Sidebar ────────────────────────────────────────── #}
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <a href="/">
        <span class="sidebar-brand-icon"><i class="bi bi-shield-check"></i></span>
        Open GRC {% if APP_VERSION %}<small style="font-size:.7em;opacity:.45">{{ APP_VERSION }}</small>{% endif %}
      </a>
    </div>

    <div class="sidebar-body">
      {# ── General ───────────────────────────────────────── #}
      <a href="{% url 'home' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <a href="{% url 'calendar' %}" class="sidebar-link">
        <i class="bi bi-calendar3"></i> {% trans "Calendar" %}
      </a>

      {# ── Gouvernance ─────────────────────────────────── #}
      <div class="sidebar-section">{% trans "Governance" %}</div>
      <a href="{% url 'context:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navGouv" aria-expanded="true">
        <i class="bi bi-diagram-3"></i> {% trans "Organization" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navGouv">
        <a href="{% url 'context:scope-list' %}" class="sidebar-link sidebar-sub">{% trans "Scopes" %}</a>
        <a href="{% url 'context:issue-list' %}" class="sidebar-link sidebar-sub">{% trans "Issues" %}</a>
        <a href="{% url 'context:stakeholder-list' %}" class="sidebar-link sidebar-sub">{% trans "Stakeholders" %}</a>
        <a href="{% url 'context:objective-list' %}" class="sidebar-link sidebar-sub">{% trans "Objectives" %}</a>
        <a href="{% url 'context:swot-list' %}" class="sidebar-link sidebar-sub">{% trans "SWOT analyses" %}</a>
      </div>
      <a href="{% url 'context:role-list' %}" class="sidebar-link">
        <i class="bi bi-person-badge"></i> {% trans "Roles" %}
      </a>
      <a href="{% url 'context:activity-list' %}" class="sidebar-link">
        <i class="bi bi-activity"></i> {% trans "Activities" %}
      </a>

      {# ── Actifs ──────────────────────────────────────── #}
      <div class="sidebar-section">{% trans "Assets" %}</div>
      <a href="{% url 'assets:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navActifs" aria-expanded="true">
        <i class="bi bi-box-seam"></i> {% trans "Goods" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navActifs">
        <a href="{% url 'assets:essential-asset-list' %}" class="sidebar-link sidebar-sub">{% trans "Essential assets" %}</a>
        <a href="{% url 'assets:support-asset-list' %}" class="sidebar-link sidebar-sub">{% trans "Support assets" %}</a>
        <a href="{% url 'assets:group-list' %}" class="sidebar-link sidebar-sub">{% trans "Asset groups" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navSites" aria-expanded="true">
        <i class="bi bi-building"></i> {% trans "Sites" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navSites">
        <a href="{% url 'assets:site-list' %}" class="sidebar-link sidebar-sub">{% trans "Sites" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navSuppliers" aria-expanded="true">
        <i class="bi bi-truck"></i> {% trans "Suppliers" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navSuppliers">
        <a href="{% url 'assets:supplier-list' %}" class="sidebar-link sidebar-sub">{% trans "Suppliers" %}</a>
        <a href="{% url 'assets:supplier-type-list' %}" class="sidebar-link sidebar-sub">{% trans "Supplier types" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navDeps" aria-expanded="true">
        <i class="bi bi-share"></i> {% trans "Dependencies" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navDeps">
        <a href="{% url 'assets:dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Asset dependencies" %}</a>
        <a href="{% url 'assets:supplier-dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Supplier dependencies" %}</a>
        <a href="{% url 'assets:site-asset-dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Site–asset dependencies" %}</a>
        <a href="{% url 'assets:site-supplier-dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Site–supplier dependencies" %}</a>
        <a href="{% url 'assets:dependency-graph' %}" class="sidebar-link sidebar-sub">{% trans "Graph view" %}</a>
      </div>

      {# ── Gestion des risques ───────────────────────── #}
      <div class="sidebar-section">{% trans "Risk management" %}</div>
      <a href="{% url 'risks:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navRiskAssess" aria-expanded="true">
        <i class="bi bi-clipboard-data"></i> {% trans "Assessments" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navRiskAssess">
        <a href="{% url 'risks:assessment-list' %}" class="sidebar-link sidebar-sub">{% trans "Assessments" %}</a>
        <a href="{% url 'risks:criteria-list' %}" class="sidebar-link sidebar-sub">{% trans "Criteria" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navRiskReg" aria-expanded="true">
        <i class="bi bi-shield-exclamation"></i> {% trans "Register" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navRiskReg">
        <a href="{% url 'risks:risk-list' %}" class="sidebar-link sidebar-sub">{% trans "Risks" %}</a>
        <a href="{% url 'risks:treatment-plan-list' %}" class="sidebar-link sidebar-sub">{% trans "Treatment plans" %}</a>
        <a href="{% url 'risks:acceptance-list' %}" class="sidebar-link sidebar-sub">{% trans "Acceptances" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navRiskCatalogs" aria-expanded="true">
        <i class="bi bi-journal-bookmark"></i> {% trans "Catalogs" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navRiskCatalogs">
        <a href="{% url 'risks:threat-list' %}" class="sidebar-link sidebar-sub">{% trans "Threats" %}</a>
        <a href="{% url 'risks:vulnerability-list' %}" class="sidebar-link sidebar-sub">{% trans "Vulnerabilities" %}</a>
      </div>

      {# ── Conformité ──────────────────────────────────── #}
      <div class="sidebar-section">{% trans "Compliance" %}</div>
      <a href="{% url 'compliance:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navReferentiels" aria-expanded="true">
        <i class="bi bi-journal-bookmark"></i> {% trans "Frameworks" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navReferentiels">
        <a href="{% url 'compliance:framework-list' %}" class="sidebar-link sidebar-sub">{% trans "List" %}</a>
        <a href="{% url 'compliance:framework-import' %}" class="sidebar-link sidebar-sub">{% trans "Import" %}</a>
      </div>
      <a href="{% url 'compliance:requirement-list' %}" class="sidebar-link">
        <i class="bi bi-list-check"></i> {% trans "Requirements" %}
      </a>
      <a href="{% url 'compliance:assessment-list' %}" class="sidebar-link">
        <i class="bi bi-clipboard-data"></i> {% trans "Assessments" %}
      </a>
      <a href="{% url 'compliance:mapping-list' %}" class="sidebar-link">
        <i class="bi bi-arrow-left-right"></i> {% trans "Mappings" %}
      </a>
      <a href="{% url 'compliance:action-plan-list' %}" class="sidebar-link">
        <i class="bi bi-kanban"></i> {% trans "Action plans" %}
      </a>

      {# ── Administration ──────────────────────────────── #}
      {% has_module_perms "system" as can_admin %}
      {% if can_admin %}
      <div class="sidebar-section">{% trans "Administration" %}</div>
      <a href="{% url 'context:tag-list' %}" class="sidebar-link">
        <i class="bi bi-tags"></i> {% trans "Tags" %}
      </a>
      {% has_perm "system.users.read" as can_users %}
      {% if can_users %}
      <a href="{% url 'accounts:user-list' %}" class="sidebar-link">
        <i class="bi bi-people"></i> {% trans "Users" %}
      </a>
      {% endif %}
      {% has_perm "system.groups.read" as can_groups %}
      {% if can_groups %}
      <a href="{% url 'accounts:group-list' %}" class="sidebar-link">
        <i class="bi bi-shield-lock"></i> {% trans "Groups" %}
      </a>
      <a href="{% url 'accounts:permission-list' %}" class="sidebar-link">
        <i class="bi bi-key"></i> {% trans "Permissions" %}
      </a>
      {% endif %}
      {% has_perm "system.audit_trail.read" as can_audit %}
      {% if can_audit %}
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navLogs" aria-expanded="true">
        <i class="bi bi-journal-text"></i> {% trans "Logs" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navLogs">
        <a href="{% url 'accounts:access-log-list' %}" class="sidebar-link sidebar-sub">{% trans "Access log" %}</a>
        <a href="{% url 'accounts:action-log-list' %}" class="sidebar-link sidebar-sub">{% trans "Action log" %}</a>
      </div>
      {% endif %}
      {% has_perm "system.admin_django.access" as can_django_admin %}
      {% if can_django_admin %}
      <a href="{% url 'admin:index' %}" class="sidebar-link">
        <i class="bi bi-gear"></i> {% trans "Django admin" %}
      </a>
      {% endif %}
      {% endif %}
    </div>

    {# ── Sidebar footer (user) ─────────────────────────── #}
    {% if user.is_authenticated %}
    <div class="sidebar-footer">
      <div class="d-flex align-items-center gap-2">
        <a href="{% url 'accounts:profile' %}" class="d-flex align-items-center text-decoration-none" style="min-width:0;flex:1">
          {% if user.avatar %}
          <img src="{{ user.avatar_32|default:user.avatar }}" alt="" style="width:1.75rem;height:1.75rem;border-radius:var(--radius-sm);object-fit:cover" class="me-2">
          {% else %}
          <div style="width:1.75rem;height:1.75rem;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent-soft),rgba(99,102,241,.15));color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.6875rem;font-weight:650;letter-spacing:-.01em;" class="me-2">
            {{ user.display_name|truncatechars:1 }}
          </div>
          {% endif %}
          <span class="text-truncate" style="max-width:140px;font-size:.8125rem">{{ user.display_name }}</span>
        </a>
        <form method="post" action="{% url 'accounts:logout' %}" class="m-0">
          {% csrf_token %}
          <button type="submit" class="btn btn-link p-0 d-flex align-items-center" style="color:var(--text-muted);font-size:1rem" title="{% trans 'Sign out' %}">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </form>
      </div>
    </div>
    {% endif %}
  </aside>

  {# ── Mobile menu toggle ──────────────────────────────── #}
  <button class="mobile-menu-toggle" onclick="toggleSidebar()">
    <div class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>

  {# ── Main content ─────────────────────────────────────── #}
  <main class="main-content">
    <div class="container-xl">
      {% block content %}{% endblock %}
    </div>
  </main>
  {% endblock %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/htmx.org@2.0.4"
          integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/js/tom-select.complete.min.js"></script>
  <script>
  /* ── Tag input (Tom Select) ──────────────────────── */
  (function() {
    function getCsrfToken() {
      var el = document.querySelector('[name=csrfmiddlewaretoken]');
      if (el) return el.value;
      var m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? m[1] : '';
    }

    function initTagInputs() {
      document.querySelectorAll('select[name="tags"]:not(.tomselected)').forEach(function(el) {
        var ts = new TomSelect(el, {
          plugins: ['remove_button'],
          create: function(input, callback) {
            fetch('{% url "context:tag-create-inline" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
              },
              body: JSON.stringify({ name: input.trim() })
            })
            .then(function(resp) {
              if (!resp.ok) throw new Error('Tag creation failed');
              return resp.json();
            })
            .then(function(tag) {
              callback({ value: tag.id, text: tag.name });
            })
            .catch(function() { callback(); });
          },
          createOnBlur: true,
          persist: false,
          render: {
            option_create: function(data, escape) {
              return '<div class="create">{% trans "Create" %} <strong>' + escape(data.input) + '</strong>&hellip;</div>';
            }
          }
        });

        /* Space and comma trigger tag creation */
        ts.control_input.addEventListener('keydown', function(e) {
          if (e.key === ' ' || e.key === ',') {
            var val = ts.control_input.value.trim();
            if (val) {
              ts.createItem(val);
              e.preventDefault();
            }
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTagInputs);
    } else {
      initTagInputs();
    }
    /* Re-init after HTMX swaps */
    document.body.addEventListener('htmx:afterSettle', initTagInputs);
  })();
  </script>
  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
      document.getElementById('sidebarBackdrop').classList.toggle('show');
      document.body.classList.toggle('sidebar-open');
    }
    /* Auto-expand and highlight the active sidebar link;
       on mobile, collapse all sections except the one containing the active link */
    (function() {
      var path = location.pathname;
      var isMobile = window.matchMedia('(max-width: 991.98px)').matches;
      var activeCollapse = null;

      document.querySelectorAll('.sidebar-link').forEach(function(link) {
        if (link.getAttribute('href') === path) {
          link.classList.add('active');
          var collapse = link.closest('.collapse');
          if (collapse) {
            activeCollapse = collapse;
          }
        }
      });

      /* On mobile, collapse all sections by default, then expand only the active one */
      if (isMobile) {
        document.querySelectorAll('.sidebar-body .collapse.show').forEach(function(el) {
          if (el !== activeCollapse) {
            el.classList.remove('show');
            var btn = document.querySelector('[data-bs-target="#' + el.id + '"]');
            if (btn) btn.setAttribute('aria-expanded', 'false');
          }
        });
      }

      if (activeCollapse) {
        activeCollapse.classList.add('show');
        var btn = document.querySelector('[data-bs-target="#' + activeCollapse.id + '"]');
        if (btn) btn.setAttribute('aria-expanded', 'true');
      }
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
