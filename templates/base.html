{% load static %}
{% load accounts_tags %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Open GRC{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.bootstrap5.min.css"
        rel="stylesheet">
  <style>
    /* ── Design tokens ────────────────────────────────── */
    :root {
      --sidebar-w: 260px;
      --radius-sm: .5rem;
      --radius-md: .75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
      --shadow-xs: 0 1px 2px rgba(0,0,0,.04);
      --shadow-sm: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,.06);
      --shadow-lg: 0 8px 24px rgba(0,0,0,.08);
      --surface: #ffffff;
      --surface-raised: #ffffff;
      --surface-muted: #f8fafc;
      --bg-page: #f1f5f9;
      --border-light: #e2e8f0;
      --border-subtle: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --accent: #6366f1;
      --accent-soft: #eef2ff;
      --accent-hover: #4f46e5;
      --success: #10b981;
      --success-soft: #ecfdf5;
      --warning: #f59e0b;
      --warning-soft: #fffbeb;
      --danger: #ef4444;
      --danger-soft: #fef2f2;
      --info: #06b6d4;
      --info-soft: #ecfeff;
      --transition-fast: .15s cubic-bezier(.4,0,.2,1);
      --transition-normal: .25s cubic-bezier(.4,0,.2,1);
      --text-sidebar-sub: #8494a7;
    }

    [data-bs-theme="dark"] {
      --surface: #1e293b;
      --surface-raised: #1e293b;
      --surface-muted: #0f172a;
      --bg-page: #0f172a;
      --border-light: #334155;
      --border-subtle: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #818cf8;
      --accent-soft: rgba(99,102,241,.12);
      --accent-hover: #a5b4fc;
      --success-soft: rgba(16,185,129,.12);
      --warning-soft: rgba(245,158,11,.12);
      --danger-soft: rgba(239,68,68,.12);
      --info-soft: rgba(6,182,212,.12);
      --shadow-xs: 0 1px 2px rgba(0,0,0,.2);
      --shadow-sm: 0 1px 3px rgba(0,0,0,.25);
      --shadow-md: 0 4px 12px rgba(0,0,0,.3);
      --shadow-lg: 0 8px 24px rgba(0,0,0,.35);
      --text-sidebar-sub: #64748b;
    }

    /* ── Global ────────────────────────────────────────── */
    html { font-size: 16px; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ── Typography ────────────────────────────────────── */
    h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -.01em; color: var(--text-primary); }
    h2 { font-size: 1.25rem; font-weight: 600; letter-spacing: -.01em; color: var(--text-primary); }
    h3 { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
    h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
    h5 { font-size: .9rem; font-weight: 600; color: var(--text-primary); }
    h6 { font-size: .85rem; font-weight: 600; color: var(--text-secondary); }
    .display-4 { font-size: 2rem; font-weight: 700; letter-spacing: -.02em; }
    .display-6 { font-size: 1.6rem; font-weight: 700; letter-spacing: -.02em; }

    /* ── Sidebar ───────────────────────────────────────── */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--sidebar-w);
      background: var(--surface);
      border-right: 1px solid var(--border-light);
      overflow-y: auto;
      z-index: 1040;
      display: flex;
      flex-direction: column;
      transition: transform var(--transition-normal);
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 2px; }

    .sidebar-brand {
      padding: 1.25rem 1.25rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-brand a {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--accent);
      text-decoration: none;
      letter-spacing: -.02em;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .sidebar-brand-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: #fff;
      font-size: .85rem;
    }

    .sidebar-body {
      flex: 1;
      padding: .75rem 0;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 1.25rem 1.25rem .5rem;
      font-size: .65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-muted);
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: .6rem;
      padding: .45rem 1.25rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: .85rem;
      font-weight: 450;
      border-radius: 0;
      transition: all var(--transition-fast);
      margin: 1px 0;
    }
    .sidebar-link:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .sidebar-link.active {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }
    .sidebar-link i {
      font-size: .95rem;
      width: 1.25rem;
      text-align: center;
      color: var(--text-muted);
      transition: color var(--transition-fast);
    }
    .sidebar-link:hover i,
    .sidebar-link.active i { color: var(--accent); }
    .sidebar-sub { padding-left: 3.1rem; font-size: .82rem; color: var(--text-sidebar-sub); }

    .sidebar-body .collapse {
      position: relative;
    }
    .sidebar-body .collapse::before {
      content: '';
      position: absolute;
      left: 1.85rem;
      top: .25rem;
      bottom: .25rem;
      width: 1px;
      background: var(--border-light);
      border-radius: 1px;
    }

    .sidebar-collapse-btn {
      display: flex;
      align-items: center;
      gap: .6rem;
      padding: .45rem 1.25rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: .85rem;
      font-weight: 450;
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .sidebar-collapse-btn:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .sidebar-collapse-btn:hover i:first-child { color: var(--accent); }
    .sidebar-collapse-btn i.bi-chevron-down {
      margin-left: auto;
      font-size: .6rem;
      transition: transform .2s;
      color: var(--text-muted);
    }
    .sidebar-collapse-btn[aria-expanded="true"] i.bi-chevron-down {
      transform: rotate(180deg);
    }
    .sidebar-collapse-btn i:first-child {
      font-size: .95rem;
      width: 1.25rem;
      text-align: center;
      color: var(--text-muted);
    }

    .sidebar-footer {
      border-top: 1px solid var(--border-light);
      padding: .85rem 1.25rem;
    }
    .sidebar-footer .dropdown-toggle {
      color: var(--text-secondary);
      font-size: .85rem;
      font-weight: 500;
    }
    .sidebar-footer .dropdown-toggle:hover { color: var(--accent); }

    /* ── Main content ──────────────────────────────────── */
    .main-content {
      margin-left: var(--sidebar-w);
      padding: 2.5rem 3rem 5rem;
      min-height: 100vh;
      background: var(--bg-page);
    }

    /* ── Vertical rhythm ──────────────────────────────── */
    .main-content h1,
    .main-content h2 { margin-bottom: 1.5rem; }
    .main-content .d-flex > h1,
    .main-content .d-flex > h2 { margin-bottom: 0; }
    .main-content h3,
    .main-content h5.card-title { margin-bottom: 1rem; }
    .main-content hr { margin: 2.5rem 0; border-color: var(--border-light); opacity: 1; }
    .main-content .card { margin-bottom: 1.5rem; }
    .main-content .row.g-3 { --bs-gutter-y: 1.25rem; }
    .main-content .row.g-4 { --bs-gutter-y: 1.5rem; }
    .main-content .table-responsive { margin-top: .75rem; margin-bottom: 2rem; }
    .main-content form.row { margin-bottom: 2rem; }
    .main-content .help-banner { margin-bottom: 1.5rem; }
    .main-content > .container-xl > .d-flex:first-child { margin-bottom: 1.75rem; }
    .main-content .pagination { margin-top: 1.25rem; }
    .main-content .alert { margin-bottom: 1.5rem; }
    .main-content .mb-3 { margin-bottom: 1.25rem !important; }
    .main-content .mb-4 { margin-bottom: 2rem !important; }

    /* ── Cards — Soft UI ───────────────────────────────── */
    .card {
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: var(--surface-raised);
      box-shadow: var(--shadow-xs);
      transition: box-shadow var(--transition-normal), transform var(--transition-normal);
    }
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    .card-body { padding: 1.25rem 1.5rem; }
    .card-title { font-weight: 600; color: var(--text-primary); }

    /* ── Stat cards (bento) ────────────────────────────── */
    .stat-card {
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: var(--surface-raised);
      box-shadow: var(--shadow-xs);
      padding: 1.25rem 1.5rem;
      transition: all var(--transition-normal);
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .stat-card-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: var(--radius-md);
      font-size: 1.1rem;
      margin-bottom: .75rem;
    }
    .stat-card-icon.accent { background: var(--accent-soft); color: var(--accent); }
    .stat-card-icon.success { background: var(--success-soft); color: var(--success); }
    .stat-card-icon.warning { background: var(--warning-soft); color: var(--warning); }
    .stat-card-icon.danger { background: var(--danger-soft); color: var(--danger); }
    .stat-card-icon.info { background: var(--info-soft); color: var(--info); }
    .stat-card-label {
      font-size: .78rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: .35rem;
      text-transform: uppercase;
      letter-spacing: .03em;
    }
    .stat-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--text-primary);
      line-height: 1.2;
    }
    .stat-card-footer {
      margin-top: auto;
      padding-top: .75rem;
    }
    .stat-card-link {
      font-size: .8rem;
      font-weight: 500;
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      transition: gap var(--transition-fast);
    }
    .stat-card-link:hover { gap: .5rem; color: var(--accent-hover); }
    .stat-card-link::after { content: '\2192'; font-size: .85rem; }

    /* ── Tables ────────────────────────────────────────── */
    .table {
      --bs-table-bg: transparent;
      font-size: .85rem;
    }
    .table > thead > tr > th {
      font-size: .72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border-light);
      padding: .75rem;
      background: transparent;
    }
    .table > thead.table-dark {
      --bs-table-bg: transparent;
      --bs-table-color: var(--text-muted);
      --bs-table-border-color: var(--border-light);
      font-weight: 600;
    }
    .table > thead.table-dark > tr > th {
      color: var(--text-muted);
      background: transparent;
    }
    .table > tbody > tr {
      transition: background var(--transition-fast);
    }
    .table > tbody > tr:hover {
      background: var(--accent-soft) !important;
    }
    .table > :not(caption) > * > * {
      padding: .75rem;
      border-bottom-color: var(--border-light);
    }
    .table-striped > tbody > tr:nth-of-type(odd) > * {
      --bs-table-striped-bg: transparent;
    }

    /* ── Buttons ───────────────────────────────────────── */
    .btn {
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: .85rem;
      padding: .45rem 1rem;
      transition: all var(--transition-fast);
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .btn-outline-primary {
      color: var(--accent);
      border-color: var(--accent);
    }
    .btn-outline-primary:hover {
      background: var(--accent);
      border-color: var(--accent);
    }
    .btn-outline-secondary {
      color: var(--text-secondary);
      border-color: var(--border-light);
    }
    .btn-outline-secondary:hover {
      background: var(--surface-muted);
      border-color: var(--border-light);
      color: var(--text-primary);
    }
    .btn-sm { padding: .3rem .75rem; font-size: .8rem; }

    /* ── Badges ────────────────────────────────────────── */
    .badge {
      font-weight: 550;
      font-size: .72rem;
      padding: .3em .6em;
      border-radius: var(--radius-sm);
    }

    /* ── Tabs ──────────────────────────────────────────── */
    .nav-tabs {
      border-bottom: 2px solid var(--border-light);
      gap: .25rem;
    }
    .nav-tabs .nav-link {
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      color: var(--text-muted);
      font-weight: 500;
      font-size: .85rem;
      padding: .6rem 1rem;
      transition: all var(--transition-fast);
      border-radius: 0;
    }
    .nav-tabs .nav-link:hover {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: transparent;
    }
    .nav-tabs .nav-link.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: transparent;
      font-weight: 600;
    }

    /* ── Alerts ────────────────────────────────────────── */
    .alert {
      border-radius: var(--radius-md);
      border: 1px solid;
      font-size: .88rem;
    }
    .alert-danger {
      background: var(--danger-soft);
      border-color: rgba(239,68,68,.2);
      color: var(--danger);
    }
    .alert-warning {
      background: var(--warning-soft);
      border-color: rgba(245,158,11,.2);
      color: #92400e;
    }
    [data-bs-theme="dark"] .alert-warning { color: var(--warning); }
    .alert-success {
      background: var(--success-soft);
      border-color: rgba(16,185,129,.2);
      color: #065f46;
    }
    [data-bs-theme="dark"] .alert-success { color: var(--success); }
    .alert-info {
      background: var(--info-soft);
      border-color: rgba(6,182,212,.2);
      color: #155e75;
    }
    [data-bs-theme="dark"] .alert-info { color: var(--info); }

    /* ── Forms ─────────────────────────────────────────── */
    .form-control, .form-select {
      border-radius: var(--radius-sm);
      border-color: var(--border-light);
      font-size: .88rem;
      padding: .5rem .85rem;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,.12);
    }
    .form-label {
      font-size: .82rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: .35rem;
    }
    .form-text { font-size: .78rem; color: var(--text-muted); }

    /* ── Progress bars ─────────────────────────────────── */
    .progress {
      border-radius: var(--radius-sm);
      background: var(--surface-muted);
      overflow: hidden;
    }
    .progress-bar {
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: .72rem;
    }

    /* ── Pagination ────────────────────────────────────── */
    .page-link {
      border-radius: var(--radius-sm);
      font-size: .82rem;
      border-color: var(--border-light);
      color: var(--text-secondary);
      margin: 0 2px;
    }
    .page-item.active .page-link {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* ── Dropdowns ─────────────────────────────────────── */
    .dropdown-menu {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-lg);
      padding: .35rem;
      font-size: .85rem;
    }
    .dropdown-item {
      border-radius: var(--radius-sm);
      padding: .4rem .75rem;
      font-size: .85rem;
      transition: background var(--transition-fast);
    }
    .dropdown-item:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* ── Help banner ──────────────────────────────────── */
    .help-banner {
      background: var(--surface-muted);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
    }

    /* ── Hero section ─────────────────────────────────── */
    .hero-section {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: #fff;
      border-radius: var(--radius-xl);
      padding: 1.75rem 2rem;
      box-shadow: 0 4px 20px rgba(79,70,229,.25);
    }
    [data-bs-theme="dark"] .hero-section {
      background: linear-gradient(135deg, #3730a3 0%, #5b21b6 100%);
      box-shadow: 0 4px 20px rgba(55,48,163,.3);
    }
    .hero-section .progress {
      background: rgba(255,255,255,.18);
      height: 1.25rem;
    }
    .hero-section .progress-bar { font-size: .78rem; }

    /* ── Section header ───────────────────────────────── */
    .section-header {
      display: flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: 1.25rem;
    }
    .section-header-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-sm);
      font-size: .9rem;
    }

    /* ── Reference codes ──────────────────────────────── */
    .ref {
      font-family: 'SFMono-Regular', 'Menlo', 'Consolas', 'Liberation Mono', monospace;
      font-size: .82rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    /* ── Filter chips ─────────────────────────────────── */
    .filter-chip {
      display: inline-flex;
      align-items: center;
      padding: .3rem .85rem;
      font-size: .8rem;
      font-weight: 500;
      border-radius: 2rem;
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: var(--surface);
      text-decoration: none;
      transition: all var(--transition-fast);
    }
    .filter-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }
    .filter-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .filter-chip.active-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: #fff;
    }
    .filter-chip.active-warning {
      background: var(--warning);
      border-color: var(--warning);
      color: #fff;
    }

    /* ── Tom Select overrides ─────────────────────────── */
    .ts-wrapper.multi .ts-control > .item {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: .82rem;
    }
    .ts-wrapper .ts-control {
      border-color: var(--border-light);
      border-radius: var(--radius-sm);
      font-size: .88rem;
      padding: .4rem .6rem;
    }
    .ts-wrapper.focus .ts-control {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,.12);
    }
    .ts-dropdown {
      border-color: var(--border-light);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
    }
    .ts-dropdown .active {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .ts-dropdown .create {
      color: var(--accent);
    }
    [data-bs-theme="dark"] .ts-wrapper .ts-control {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border-light);
    }
    [data-bs-theme="dark"] .ts-dropdown {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border-light);
    }
    [data-bs-theme="dark"] .ts-dropdown .option {
      color: var(--text-primary);
    }

    /* ── Mobile ────────────────────────────────────────── */
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      backdrop-filter: blur(4px);
      z-index: 1035;
    }
    .sidebar-toggle {
      display: none;
    }
    /* Close button inside sidebar on mobile */
    .sidebar .sidebar-toggle {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      color: var(--text-secondary);
      padding: .35rem .55rem;
    }
    /* Mobile top bar */
    .mobile-topbar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3.25rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border-light);
      z-index: 1040;
      align-items: center;
      padding: 0 .75rem;
      gap: .5rem;
      box-shadow: var(--shadow-sm);
    }
    .mobile-topbar-toggle {
      background: transparent;
      border: none;
      font-size: 1.35rem;
      color: var(--text-secondary);
      padding: .25rem .4rem;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .mobile-topbar-toggle:active {
      background: var(--surface-muted);
    }
    .mobile-topbar-brand {
      font-weight: 600;
      font-size: .95rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .mobile-topbar-brand i {
      color: var(--accent);
      font-size: 1.1rem;
    }
    @media (max-width: 991.98px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.show { transform: translateX(0); }
      .sidebar-backdrop.show { display: block; }
      .sidebar .sidebar-toggle { display: inline-flex; }
      .mobile-topbar { display: flex; }
      .main-content { margin-left: 0; padding: 3.75rem 1rem 4rem; }
      .main-content h1 { font-size: 1.25rem; }
      .main-content h2 { font-size: 1.1rem; }
      .main-content hr { margin: 1.5rem 0; }

      /* Stat cards: compact on mobile */
      .stat-card { padding: 1rem 1.15rem; }
      .stat-card-value { font-size: 1.5rem; }
      .stat-card-icon { width: 2.1rem; height: 2.1rem; font-size: .95rem; margin-bottom: .5rem; }

      /* Hero section responsive */
      .hero-section { padding: 1.25rem 1.15rem; }
      .hero-section .display-4 { font-size: 1.5rem; }
      .hero-section h2 { font-size: 1.05rem; }
      .hero-section p { font-size: .78rem !important; }

      /* Cards compact */
      .card-body { padding: 1rem 1.15rem; }

      /* Tables scroll hint */
      .table-responsive { -webkit-overflow-scrolling: touch; }

      /* Buttons touch-friendly */
      .btn { min-height: 2.5rem; }
      .btn-sm { min-height: 2rem; }

      /* Section headers compact */
      .section-header { margin-bottom: 1rem; }
      .section-header h2 { font-size: 1rem; }
    }
    @media (max-width: 575.98px) {
      .main-content { padding: 3.75rem .75rem 3rem; }

      /* Stack stat cards nicely on very small screens */
      .stat-card { padding: .85rem 1rem; }
      .stat-card-value { font-size: 1.35rem; }

      /* Risk matrix: allow horizontal scroll */
      .risk-matrix-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }
    @media (min-width: 992px) and (max-width: 1399.98px) {
      .main-content { padding: 2.5rem 2rem 4rem; }
    }
  </style>
  <script>
    (function(){
      var m = window.matchMedia('(prefers-color-scheme: dark)');
      function apply(dark) {
        document.documentElement.setAttribute('data-bs-theme', dark ? 'dark' : 'light');
      }
      apply(m.matches);
      m.addEventListener('change', function(e) { apply(e.matches); });
    })();
  </script>
  {% block extra_css %}{% endblock %}
</head>
<body>
  {% block layout %}
  {# ── Sidebar ────────────────────────────────────────── #}
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <a href="/">
        <span class="sidebar-brand-icon"><i class="bi bi-shield-check"></i></span>
        Open GRC {% if APP_VERSION %}<small style="font-size:.7em;opacity:.45">{{ APP_VERSION }}</small>{% endif %}
      </a>
      <button class="sidebar-toggle d-lg-none" onclick="toggleSidebar()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="sidebar-body">
      {# ── General ───────────────────────────────────────── #}
      <a href="{% url 'home' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <a href="{% url 'calendar' %}" class="sidebar-link">
        <i class="bi bi-calendar3"></i> {% trans "Calendar" %}
      </a>

      {# ── Gouvernance ─────────────────────────────────── #}
      <div class="sidebar-section">{% trans "Governance" %}</div>
      <a href="{% url 'context:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navGouv" aria-expanded="true">
        <i class="bi bi-diagram-3"></i> {% trans "Organization" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navGouv">
        <a href="{% url 'context:scope-list' %}" class="sidebar-link sidebar-sub">{% trans "Scopes" %}</a>
        <a href="{% url 'context:issue-list' %}" class="sidebar-link sidebar-sub">{% trans "Issues" %}</a>
        <a href="{% url 'context:stakeholder-list' %}" class="sidebar-link sidebar-sub">{% trans "Stakeholders" %}</a>
        <a href="{% url 'context:objective-list' %}" class="sidebar-link sidebar-sub">{% trans "Objectives" %}</a>
        <a href="{% url 'context:swot-list' %}" class="sidebar-link sidebar-sub">{% trans "SWOT analyses" %}</a>
      </div>
      <a href="{% url 'context:role-list' %}" class="sidebar-link">
        <i class="bi bi-person-badge"></i> {% trans "Roles" %}
      </a>
      <a href="{% url 'context:activity-list' %}" class="sidebar-link">
        <i class="bi bi-activity"></i> {% trans "Activities" %}
      </a>

      {# ── Actifs ──────────────────────────────────────── #}
      <div class="sidebar-section">{% trans "Assets" %}</div>
      <a href="{% url 'assets:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navActifs" aria-expanded="true">
        <i class="bi bi-box-seam"></i> {% trans "Goods" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navActifs">
        <a href="{% url 'assets:essential-asset-list' %}" class="sidebar-link sidebar-sub">{% trans "Essential assets" %}</a>
        <a href="{% url 'assets:support-asset-list' %}" class="sidebar-link sidebar-sub">{% trans "Support assets" %}</a>
        <a href="{% url 'assets:group-list' %}" class="sidebar-link sidebar-sub">{% trans "Asset groups" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navSites" aria-expanded="true">
        <i class="bi bi-building"></i> {% trans "Sites" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navSites">
        <a href="{% url 'assets:site-list' %}" class="sidebar-link sidebar-sub">{% trans "Sites" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navSuppliers" aria-expanded="true">
        <i class="bi bi-truck"></i> {% trans "Suppliers" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navSuppliers">
        <a href="{% url 'assets:supplier-list' %}" class="sidebar-link sidebar-sub">{% trans "Suppliers" %}</a>
        <a href="{% url 'assets:supplier-type-list' %}" class="sidebar-link sidebar-sub">{% trans "Supplier types" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navDeps" aria-expanded="true">
        <i class="bi bi-share"></i> {% trans "Dependencies" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navDeps">
        <a href="{% url 'assets:dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Asset dependencies" %}</a>
        <a href="{% url 'assets:supplier-dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Supplier dependencies" %}</a>
        <a href="{% url 'assets:site-asset-dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Site–asset dependencies" %}</a>
        <a href="{% url 'assets:site-supplier-dependency-list' %}" class="sidebar-link sidebar-sub">{% trans "Site–supplier dependencies" %}</a>
        <a href="{% url 'assets:dependency-graph' %}" class="sidebar-link sidebar-sub">{% trans "Graph view" %}</a>
      </div>

      {# ── Gestion des risques ───────────────────────── #}
      <div class="sidebar-section">{% trans "Risk management" %}</div>
      <a href="{% url 'risks:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navRiskAssess" aria-expanded="true">
        <i class="bi bi-clipboard-data"></i> {% trans "Assessments" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navRiskAssess">
        <a href="{% url 'risks:assessment-list' %}" class="sidebar-link sidebar-sub">{% trans "Assessments" %}</a>
        <a href="{% url 'risks:criteria-list' %}" class="sidebar-link sidebar-sub">{% trans "Criteria" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navRiskReg" aria-expanded="true">
        <i class="bi bi-shield-exclamation"></i> {% trans "Register" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navRiskReg">
        <a href="{% url 'risks:risk-list' %}" class="sidebar-link sidebar-sub">{% trans "Risks" %}</a>
        <a href="{% url 'risks:treatment-plan-list' %}" class="sidebar-link sidebar-sub">{% trans "Treatment plans" %}</a>
        <a href="{% url 'risks:acceptance-list' %}" class="sidebar-link sidebar-sub">{% trans "Acceptances" %}</a>
      </div>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navRiskCatalogs" aria-expanded="true">
        <i class="bi bi-journal-bookmark"></i> {% trans "Catalogs" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navRiskCatalogs">
        <a href="{% url 'risks:threat-list' %}" class="sidebar-link sidebar-sub">{% trans "Threats" %}</a>
        <a href="{% url 'risks:vulnerability-list' %}" class="sidebar-link sidebar-sub">{% trans "Vulnerabilities" %}</a>
      </div>

      {# ── Conformité ──────────────────────────────────── #}
      <div class="sidebar-section">{% trans "Compliance" %}</div>
      <a href="{% url 'compliance:dashboard' %}" class="sidebar-link">
        <i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
      </a>
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navReferentiels" aria-expanded="true">
        <i class="bi bi-journal-bookmark"></i> {% trans "Frameworks" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navReferentiels">
        <a href="{% url 'compliance:framework-list' %}" class="sidebar-link sidebar-sub">{% trans "List" %}</a>
        <a href="{% url 'compliance:framework-import' %}" class="sidebar-link sidebar-sub">{% trans "Import" %}</a>
      </div>
      <a href="{% url 'compliance:requirement-list' %}" class="sidebar-link">
        <i class="bi bi-list-check"></i> {% trans "Requirements" %}
      </a>
      <a href="{% url 'compliance:assessment-list' %}" class="sidebar-link">
        <i class="bi bi-clipboard-data"></i> {% trans "Assessments" %}
      </a>
      <a href="{% url 'compliance:mapping-list' %}" class="sidebar-link">
        <i class="bi bi-arrow-left-right"></i> {% trans "Mappings" %}
      </a>
      <a href="{% url 'compliance:action-plan-list' %}" class="sidebar-link">
        <i class="bi bi-kanban"></i> {% trans "Action plans" %}
      </a>

      {# ── Administration ──────────────────────────────── #}
      {% has_module_perms "system" as can_admin %}
      {% if can_admin %}
      <div class="sidebar-section">{% trans "Administration" %}</div>
      <a href="{% url 'context:tag-list' %}" class="sidebar-link">
        <i class="bi bi-tags"></i> {% trans "Tags" %}
      </a>
      {% has_perm "system.users.read" as can_users %}
      {% if can_users %}
      <a href="{% url 'accounts:user-list' %}" class="sidebar-link">
        <i class="bi bi-people"></i> {% trans "Users" %}
      </a>
      {% endif %}
      {% has_perm "system.groups.read" as can_groups %}
      {% if can_groups %}
      <a href="{% url 'accounts:group-list' %}" class="sidebar-link">
        <i class="bi bi-shield-lock"></i> {% trans "Groups" %}
      </a>
      <a href="{% url 'accounts:permission-list' %}" class="sidebar-link">
        <i class="bi bi-key"></i> {% trans "Permissions" %}
      </a>
      {% endif %}
      {% has_perm "system.audit_trail.read" as can_audit %}
      {% if can_audit %}
      <button class="sidebar-collapse-btn" data-bs-toggle="collapse" data-bs-target="#navLogs" aria-expanded="true">
        <i class="bi bi-journal-text"></i> {% trans "Logs" %}
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="collapse show" id="navLogs">
        <a href="{% url 'accounts:access-log-list' %}" class="sidebar-link sidebar-sub">{% trans "Access log" %}</a>
        <a href="{% url 'accounts:action-log-list' %}" class="sidebar-link sidebar-sub">{% trans "Action log" %}</a>
      </div>
      {% endif %}
      {% has_perm "system.admin_django.access" as can_django_admin %}
      {% if can_django_admin %}
      <a href="{% url 'admin:index' %}" class="sidebar-link">
        <i class="bi bi-gear"></i> {% trans "Django admin" %}
      </a>
      {% endif %}
      {% endif %}
    </div>

    {# ── Sidebar footer (user) ─────────────────────────── #}
    {% if user.is_authenticated %}
    <div class="sidebar-footer">
      <div class="dropdown">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle"
           data-bs-toggle="dropdown" aria-expanded="false">
          <div style="width:1.75rem;height:1.75rem;border-radius:var(--radius-sm);background:var(--accent-soft);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;" class="me-2">
            {{ user.display_name|truncatechars:1 }}
          </div>
          <span class="text-truncate" style="max-width:140px">{{ user.display_name }}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
          <li><a class="dropdown-item" href="{% url 'accounts:profile' %}"><i class="bi bi-person me-2"></i>{% trans "My profile" %}</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <form method="post" action="{% url 'accounts:logout' %}">
              {% csrf_token %}
              <button type="submit" class="dropdown-item"><i class="bi bi-box-arrow-right me-2"></i>{% trans "Sign out" %}</button>
            </form>
          </li>
        </ul>
      </div>
    </div>
    {% endif %}
  </aside>

  {# ── Mobile top bar ───────────────────────────────────── #}
  <div class="mobile-topbar">
    <button class="mobile-topbar-toggle" onclick="toggleSidebar()">
      <i class="bi bi-list"></i>
    </button>
    <span class="mobile-topbar-brand">
      <i class="bi bi-shield-check"></i> Open GRC
    </span>
  </div>

  {# ── Main content ─────────────────────────────────────── #}
  <main class="main-content">
    <div class="container-xl">
      {% block content %}{% endblock %}
    </div>
  </main>
  {% endblock %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/htmx.org@2.0.4"
          integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/js/tom-select.complete.min.js"></script>
  <script>
  /* ── Tag input (Tom Select) ──────────────────────── */
  (function() {
    function getCsrfToken() {
      var el = document.querySelector('[name=csrfmiddlewaretoken]');
      if (el) return el.value;
      var m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? m[1] : '';
    }

    function initTagInputs() {
      document.querySelectorAll('select[name="tags"]:not(.tomselected)').forEach(function(el) {
        var ts = new TomSelect(el, {
          plugins: ['remove_button'],
          create: function(input, callback) {
            fetch('{% url "context:tag-create-inline" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
              },
              body: JSON.stringify({ name: input.trim() })
            })
            .then(function(resp) {
              if (!resp.ok) throw new Error('Tag creation failed');
              return resp.json();
            })
            .then(function(tag) {
              callback({ value: tag.id, text: tag.name });
            })
            .catch(function() { callback(); });
          },
          createOnBlur: true,
          persist: false,
          render: {
            option_create: function(data, escape) {
              return '<div class="create">{% trans "Create" %} <strong>' + escape(data.input) + '</strong>&hellip;</div>';
            }
          }
        });

        /* Space and comma trigger tag creation */
        ts.control_input.addEventListener('keydown', function(e) {
          if (e.key === ' ' || e.key === ',') {
            var val = ts.control_input.value.trim();
            if (val) {
              ts.createItem(val);
              e.preventDefault();
            }
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTagInputs);
    } else {
      initTagInputs();
    }
    /* Re-init after HTMX swaps */
    document.body.addEventListener('htmx:afterSettle', initTagInputs);
  })();
  </script>
  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
      document.getElementById('sidebarBackdrop').classList.toggle('show');
    }
    /* Auto-expand and highlight the active sidebar link */
    (function() {
      var path = location.pathname;
      document.querySelectorAll('.sidebar-link').forEach(function(link) {
        if (link.getAttribute('href') === path) {
          link.classList.add('active');
          var collapse = link.closest('.collapse');
          if (collapse) {
            collapse.classList.add('show');
            var btn = document.querySelector('[data-bs-target="#' + collapse.id + '"]');
            if (btn) btn.setAttribute('aria-expanded', 'true');
          }
        }
      });
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
