{% load history_tags %}
{% load i18n %}
{% if history_records %}
<style>
  .diff-block {
    font-family: 'SF Mono', SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size: 0.8rem;
    line-height: 1.6;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .diff-header {
    background: var(--surface-muted);
    padding: 0.6rem 0.85rem;
    border-bottom: 1px solid var(--border-light);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Inter', sans-serif;
    font-size: .82rem;
  }
  .diff-body {
    background: var(--surface);
    padding: 0;
    margin: 0;
  }
  .diff-line {
    padding: 2px 0.85rem;
    white-space: pre-wrap;
    word-break: break-word;
    border-left: 3px solid transparent;
  }
  .diff-line-remove {
    background: var(--danger-soft);
    border-left-color: var(--danger);
    color: var(--danger);
  }
  .diff-line-add {
    background: var(--success-soft);
    border-left-color: var(--success);
    color: var(--success);
  }
  .diff-line-context {
    color: var(--text-muted);
  }
  .diff-separator {
    padding: 2px 0.85rem;
    background: var(--accent-soft);
    color: var(--accent);
    font-size: 0.75rem;
    border-top: 1px solid var(--border-light);
    border-bottom: 1px solid var(--border-light);
  }
</style>

{% for record in history_records %}
{% history_changes record as result %}
<div class="diff-block">
  <div class="diff-header">
    <span class="badge text-bg-{% if result.is_approval %}info{% else %}{{ record.history_type|history_type_badge }}{% endif %}">
      {% if result.is_approval %}{% trans "Approval" %}{% else %}{{ record.history_type|history_type_label }}{% endif %}
    </span>
    <span class="badge" style="background:var(--accent-soft);color:var(--accent)">v{{ record.version }}</span>
    <span>{{ record.history_date|date:"d/m/Y H:i:s" }}</span>
    <span style="color:var(--text-muted)">â€” {{ record.history_user|default:"System" }}</span>
  </div>
  <div class="diff-body">
    {% if record.history_type == "+" %}
      {% history_snapshot record as snapshot %}
      {% if snapshot %}
        {% for f in snapshot %}
<div class="diff-line diff-line-add">+ {{ f.field }}: {{ f.value }}</div>
        {% endfor %}
      {% else %}
<div class="diff-line diff-line-context">  {% trans "Initial record" %}</div>
      {% endif %}
    {% elif record.history_type == "-" %}
<div class="diff-line diff-line-remove">- {% trans "Record deleted" %}</div>
    {% elif result.is_approval %}
      <div class="diff-line diff-line-{% if result.approved %}add{% else %}remove{% endif %}">
        {% if result.approved %}+ {% trans "Approval granted" %}{% else %}- {% trans "Approval revoked" %}{% endif %}
      </div>
    {% elif result.changes %}
        {% for c in result.changes %}
<div class="diff-separator">@@ {{ c.field }} @@</div>
<div class="diff-line diff-line-remove">- {{ c.field }}: {{ c.old }}</div>
<div class="diff-line diff-line-add">+ {{ c.field }}: {{ c.new }}</div>
        {% endfor %}
    {% else %}
<div class="diff-line diff-line-context">  {% trans "No changes detected" %}</div>
    {% endif %}
  </div>
</div>
{% endfor %}

{% else %}
<p style="color:var(--text-muted);font-size:.85rem">{% trans "No history available." %}</p>
{% endif %}
