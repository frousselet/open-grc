{% load history_tags %}
{% if history_records %}
<style>
  .diff-block {
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.8125rem;
    line-height: 1.6;
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .diff-header {
    background: #f1f3f5;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--bs-border-color);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .diff-body {
    background: #fafafa;
    padding: 0;
    margin: 0;
  }
  .diff-line {
    padding: 1px 0.75rem;
    white-space: pre-wrap;
    word-break: break-word;
    border-left: 3px solid transparent;
  }
  .diff-line-remove {
    background: #fdd;
    border-left-color: #e55;
    color: #8b0000;
  }
  .diff-line-add {
    background: #dfd;
    border-left-color: #3a3;
    color: #006400;
  }
  .diff-line-context {
    color: #636c76;
  }
  .diff-separator {
    padding: 2px 0.75rem;
    background: #eef;
    color: #6c6ca0;
    font-size: 0.75rem;
    border-top: 1px solid var(--bs-border-color);
    border-bottom: 1px solid var(--bs-border-color);
  }

  /* ── Dark theme ── */
  [data-bs-theme="dark"] .diff-header { background: #2b3035; }
  [data-bs-theme="dark"] .diff-body { background: #1a1d21; }
  [data-bs-theme="dark"] .diff-line-remove { background: rgba(248,81,73,.15); border-left-color: #f85149; color: #ffa198; }
  [data-bs-theme="dark"] .diff-line-add { background: rgba(63,185,80,.15); border-left-color: #3fb950; color: #7ee787; }
  [data-bs-theme="dark"] .diff-line-context { color: #8b949e; }
  [data-bs-theme="dark"] .diff-separator { background: rgba(56,58,89,.4); color: #a5a5c8; }
</style>

{% for record in history_records %}
{% history_changes record as result %}
<div class="diff-block">
  <div class="diff-header">
    <span class="badge text-bg-{% if result.is_approval %}info{% else %}{{ record.history_type|history_type_badge }}{% endif %}">
      {% if result.is_approval %}Approbation{% else %}{{ record.history_type|history_type_label }}{% endif %}
    </span>
    <span class="badge text-bg-info">v{{ record.version }}</span>
    <span>{{ record.history_date|date:"d/m/Y H:i:s" }}</span>
    <span class="text-muted">— {{ record.history_user|default:"Système" }}</span>
  </div>
  <div class="diff-body">
    {% if record.history_type == "+" %}
      {% history_snapshot record as snapshot %}
      {% if snapshot %}
        {% for f in snapshot %}
<div class="diff-line diff-line-add">+ {{ f.field }}: {{ f.value }}</div>
        {% endfor %}
      {% else %}
<div class="diff-line diff-line-context">  Enregistrement initial</div>
      {% endif %}
    {% elif record.history_type == "-" %}
<div class="diff-line diff-line-remove">- Enregistrement supprimé</div>
    {% elif result.is_approval %}
      <div class="diff-line diff-line-{% if result.approved %}add{% else %}remove{% endif %}">
        {% if result.approved %}+ Approbation accordée{% else %}- Approbation retirée{% endif %}
      </div>
    {% elif result.changes %}
        {% for c in result.changes %}
<div class="diff-separator">@@ {{ c.field }} @@</div>
<div class="diff-line diff-line-remove">- {{ c.field }}: {{ c.old }}</div>
<div class="diff-line diff-line-add">+ {{ c.field }}: {{ c.new }}</div>
        {% endfor %}
    {% else %}
<div class="diff-line diff-line-context">  Aucune modification détectée</div>
    {% endif %}
  </div>
</div>
{% endfor %}

{% else %}
<p class="text-muted">Aucun historique disponible.</p>
{% endif %}
